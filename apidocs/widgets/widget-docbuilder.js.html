<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>MLJS Source: widget-docbuilder.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	
	<link type="text/css" rel="stylesheet" href="styles/site.cerulean.css">
	
</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top ">
		<div class="navbar-inner">
			<a class="brand" href="index.html">MLJS</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="namespaces.list.html" class="dropdown-toggle" data-toggle="dropdown">Namespaces<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="com.marklogic.widgets.bits.html">bits</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="com.marklogic.widgets.actionconfig.html">actionconfig</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.actionorderer.html">actionorderer</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.actions.javascript.html">javascript</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.addressbar.html">addressbar</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.advancedsearch.html">advancedsearch</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.collectionuris.html">collectionuris</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.configwrapper.html">configwrapper</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.cooccurence.html">cooccurence</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.create.html">create</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.docheadviewer.html">docheadviewer</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.docproperties.html">docproperties</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.docviewer.html">docviewer</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.dropzone.html">dropzone</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.entityfacts.html">entityfacts</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.error.html">error</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.graphexplorer.html">graphexplorer</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.highcharts.html">highcharts</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.kratu.html">kratu</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.layouts.column.html">column</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.layouts.thickthin.html">thickthin</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.layouts.thinthick.html">thinthick</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.markings.html">markings</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.openlayers.html">openlayers</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.profile.html">profile</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.rdb2rdf.html">rdb2rdf</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.searchbar.html">searchbar</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.searchfacets.html">searchfacets</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.searchoptions.html">searchoptions</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.searchpage.html">searchpage</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.searchpager.html">searchpager</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.searchresults.html">searchresults</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.searchselection.html">searchselection</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.searchsort.html">searchsort</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.selection.html">selection</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.sparqlbar.html">sparqlbar</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.sparqlresults.html">sparqlresults</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.workplace.html">workplace</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.workplaceadmin.html">workplaceadmin</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.workplacecontext.html">workplacecontext</a>
						</li>
						
						<li>
							<a href="com.marklogic.widgets.workplacenavbar.html">workplacenavbar</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="tutorials.list.html" class="dropdown-toggle" data-toggle="dropdown">Tutorials<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="tutorial-001-intro.html">001-intro</a>
						</li>
						
						<li>
							<a href="tutorial-001-widgets-list.html">001-widgets-list</a>
						</li>
						
						<li>
							<a href="tutorial-002-intro-firstpage.html">002-intro-firstpage</a>
						</li>
						
						<li>
							<a href="tutorial-002-widgets-search.html">002-widgets-search</a>
						</li>
						
						<li>
							<a href="tutorial-003-widgets-search-render.html">003-widgets-search-render</a>
						</li>
						
						<li>
							<a href="tutorial-004-widgets-highcharts.html">004-widgets-highcharts</a>
						</li>
						
						<li>
							<a href="tutorial-011-browser-create-app.html">011-browser-create-app</a>
						</li>
						
						<li>
							<a href="tutorial-012-browser-install-app.html">012-browser-install-app</a>
						</li>
						
						<li>
							<a href="tutorial-013-browser-samples-app.html">013-browser-samples-app</a>
						</li>
						
						<li>
							<a href="tutorial-014-browser-workplace.html">014-browser-workplace</a>
						</li>
						
						<li>
							<a href="tutorial-020-angular.html">020-angular</a>
						</li>
						
						<li>
							<a href="tutorial-050-core-contexts.html">050-core-contexts</a>
						</li>
						
						<li>
							<a href="tutorial-051-core-custom-searchcontext-endpoint.html">051-core-custom-searchcontext-endpoint</a>
						</li>
						
						<li>
							<a href="tutorial-060-rest-ext.html">060-rest-ext</a>
						</li>
						
						<li>
							<a href="tutorial-901-ontology.html">901-ontology</a>
						</li>
						
						<li>
							<a href="tutorial-999-samples.html">999-samples</a>
						</li>
						
						<li>
							<a href="tutorial-all.html">all</a>
						</li>
						
						<li>
							<a href="tutorial-dev1-001-overview.html">dev1-001-overview</a>
						</li>
						
						<li>
							<a href="tutorial-dev1-002-intro.html">dev1-002-intro</a>
						</li>
						
						<li>
							<a href="tutorial-dev1-003-first-page.html">dev1-003-first-page</a>
						</li>
						
						<li>
							<a href="tutorial-dev1-004-first-widget.html">dev1-004-first-widget</a>
						</li>
						
						<li>
							<a href="tutorial-dev1-005-search-options.html">dev1-005-search-options</a>
						</li>
						
						<li>
							<a href="tutorial-dev1-006-structured-query.html">dev1-006-structured-query</a>
						</li>
						
						<li>
							<a href="tutorial-dev1-007-semantics.html">dev1-007-semantics</a>
						</li>
						
						<li>
							<a href="tutorial-dev1-008-lunch.html">dev1-008-lunch</a>
						</li>
						
						<li>
							<a href="tutorial-dev1-009-blending-mljs.html">dev1-009-blending-mljs</a>
						</li>
						
						<li>
							<a href="tutorial-dev1-010-building-demo.html">dev1-010-building-demo</a>
						</li>
						
						<li>
							<a href="tutorial-dev1-011-demo-jam.html">dev1-011-demo-jam</a>
						</li>
						
						<li>
							<a href="tutorial-dev1-012-home-time.html">dev1-012-home-time</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="global.html#com">com</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: widget-docbuilder.js</h1>
    
    <section>
        <article>
            <pre class="sunlight-highlight-javascript linenums">/*
Copyright 2012 MarkLogic Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
// global variable definitions
com = window.com || {};
com.marklogic = window.com.marklogic || {};
com.marklogic.widgets = window.com.marklogic.widgets || {};

/**
 * Provides a form builder widget to allow the creation of a document. Also includes file update widget and security widgets.
 * @constructor
 * @param {string} container - The HTML ID of the element to place this widget's content within.
 */
com.marklogic.widgets.create = function(container) {
  this.container = container;
  this.errorPublisher = new com.marklogic.events.Publisher();

  this.vertical = true; // vertical or horizontal first rendering

  this._collections = new Array();
  this._permissions = new Array(); // ?

  this.currentRow = 0;
  this.currentColumn = 0;

  this.completePublisher = new com.marklogic.events.Publisher();

  this.controlCount = 0;
  this.fileDrops = new Array();
  this.fileDropFiles = new Array();

  this.override = false;
  this.overrideEndManual = false;
  this.overrideElementId = "";

  this._doccontext = null;


  this._uriprefix = "/";

  this.controls = new Array();
  this.controlData = new Array();

  this._mode = "upload"; // upload or json or xml

  this._init();
};

com.marklogic.widgets.create.prototype.setDocumentContext = function(ctx) {
  this._doccontext = ctx;
};

com.marklogic.widgets.create.prototype.updateDocumentContent = function(json) {
  var uri = json.docuri;
  var content = json.doc;
  // update title
  var t = document.getElementById(this.container + "-title");
  t.innerHTML = "Editing document - &lt;i>" + uri + "&lt;/i>";

  // TODO update fields on page (in case trigger has updated them)
};

/**
 * Adds an error listener to this widget
 *
 * @param {function(error)} fl - The error listener to add
 */
com.marklogic.widgets.create.prototype.addErrorListener = function(fl) {
  this.errorPublisher.subscribe(fl);
};

/**
 * Removes an error listener
 *
 * @param {function(error)} fl - The error listener to remove
 */
com.marklogic.widgets.create.prototype.removeErrorListener = function(fl) {
  this.errorPublisher.unsubscribe(fl);
};

com.marklogic.widgets.create.prototype._init = function() {
  var parentel = document.getElementById(this.container);
  parentel.innerHTML =
    "&lt;div id='" + this.container + "-create' class='mljswidget panel panel-info create'>" +
      "&lt;div id='" + this.container + "-title' class='panel-heading create-title'>Create a new Document&lt;/div>" +
      "&lt;form id='" + this.container + "-create-form' class='panel-body form-horizontal create-form' role='form'>" +
        "&lt;div class='create-row' id='" + this.container + "-create-row-0'>" +
          "&lt;div class='create-col' id='" + this.container + "-create-row-0-col-0' style='float:left;'>&lt;/div>" +
        "&lt;/div>" +
      "&lt;/form>"
    "&lt;/div>&lt;div style='";
};

// LAYOUT FUNCTIONS

com.marklogic.widgets.create.prototype._place = function(html,type,id) {
  if (this.override) {
    // override placement (allows containment within widget)
    com.marklogic.widgets.appendHTML(document.getElementById(this.overrideElementId),html);
  } else {
    // place the html in the 'current' position, and increment
    var cid = this.container + "-create-row-" + this.currentRow + "-col-" + this.currentColumn;
    var cel = document.getElementById(cid);
    cel.innerHTML = html;
    if (this.vertical) {
      this.endRow();
    } else {
      // incrememnt column
      this.currentColumn++;
      // append column div to row element
      var h = "&lt;div class='create-col' id='" + this.container + "-create-row-" + this.currentRow + "-col-" + this.currentColumn + "' style='float:left;'>&lt;/div>";
      com.marklogic.widgets.appendHTML(document.getElementById(this.container + "-create-row-" + this.currentRow),h);
    }
  }

  // add the control definition to our form references link - so save can process the form
  if (undefined != type && undefined != id) {
    this.controls.push({type: type,id: id});
  }
};

/**
 * Ends the current row run and starts a new row.
 */
com.marklogic.widgets.create.prototype.endRow = function() {
  // clear previous row
  com.marklogic.widgets.appendHTML(document.getElementById(this.container + "-create-row-" + this.currentRow),"&lt;div style='clear:both'>&lt;/div>");

    // create new row
    this.currentRow++;
    // reset column counter
    this.currentColumn = 0;
    // append div to form element
    var h =
        "&lt;div class='create-row' id='" + this.container + "-create-row-" + this.currentRow + "'>" +
          "&lt;div class='create-col' id='" + this.container + "-create-row-" + this.currentRow + "-col-" + this.currentColumn + "' style='float:left;'>&lt;/div>" +
        "&lt;/div>";
    com.marklogic.widgets.appendHTML(document.getElementById(this.container + "-create-form"),h);

  return this;
};

// Configuration methods for create widget - MUST be called before control creation methods

/**
 * Specifies the creation mode for the widget. Can be "upload", "json" or "xml". If upload, the underlying browser's mime type support determines the type to send the document to MarkLogic as.
 *
 * @param {string} newMode - The new mode to use
 */
com.marklogic.widgets.create.prototype.mode = function(newMode) {
  this._mode = newMode;

  return this;
};

/**
 * Specifies the URI prefix of the newly generated document.
 *
 * @param {string} prefix - The document URI prefix to use.
 */
com.marklogic.widgets.create.prototype.uriPrefix = function(prefix) {
  this._uriprefix = prefix;

  return this;
};
com.marklogic.widgets.create.prototype.uriprefix = com.marklogic.widgets.create.prototype.uriPrefix; // backwards compatibility

/**
 * Specifies that the next created 'cell' should be to the right of the current one. Difference between a table layout and a vertical div layout.
 * Vertical is the default.
 */
com.marklogic.widgets.create.prototype.horizontal = function() {
  // draw new controls horizontally, not vertically
  this.vertical = false;

  return this;
};

/**
 * Specifies that the resultant document should also be added to a collection with the name 'user-USERID'.
 * TODO will call mljs's whoami extension to determine username, if not already known.
 */
com.marklogic.widgets.create.prototype.collectionUser = function() {
  // add user- and this user's id to the collection list

  return this;
};

/**
 * Adds the resultant document(s) to the specified collection. May be called multiple times if multiple collections are required.
 *
 * @param {string} col - Collection name to add the new document(s) to.
 */
com.marklogic.widgets.create.prototype.collection = function(col) {
  this._collections.push(col);

  return this;
};

// FORM CONTROLS

/**
 * Places a drag and drop upload control within the current cell, and creates a new cell.
 */
com.marklogic.widgets.create.prototype.dnd = function() {
  // check for browser support
  if (window.File && window.FileReader && window.FileList && window.Blob) {
    // Great success! All the File APIs are supported.
    console.log("File API is supported by this browser");
  } else {
    console.log('The File APIs are not fully supported in this browser.');
  }

  // create a drag and drop widget
  var id = this.container + "-dnd-" + ++this.controlCount;
  /*
  var html = "&lt;div id='" + id + "' class='create-dnd'>&lt;/div>";

  this._place(html,"dnd",id);

  var fd = new FileDrop(id,{dragOverClass: "create-dnd-hover"});
  this.fileDrops[id] = fd;
  this.fileDropFiles[id] = new Array();

  var self = this;
  fd.on.send = function (files) {
    // store file objects until user clicks save
    for (var f = 0;f &lt; files.length;f++) {
      self.fileDropFiles[id].push(files[f]);
    }
  };

  this.controlData[id] = {filedrop: fd};
  */

  var html = "&lt;input type='file' id='" + id + "' class='span2 form-control btn btn-default create-file' />";
  this._place(html,"dnd",id);

  var self = this;
  document.getElementById(id).onchange = function(evt) {
    console.log("file onchange fired");
    self.controlData[id] = {files: evt.target.files};
    console.log("Saved file data");
  };

  return this;
};

/**
 * Ensures that the resultant document has the specified permission object applied, in addition to those from any embedded permissions widgets.
 *
 * @param {JSON} permObject - The permission specification to use. E.g. {role: "topsecret", permission: "read"}
 */
com.marklogic.widgets.create.prototype.forcePermission = function(permObject) {
  this._permissions.push(permObject);

  return this;
};

/**
 * Adds a permissions drop down widget to the current cell, and creates a new cell.
 *
 * @param {boolean} allowMultiple - Whether to allow multiple roles to be selected. NOT SUPPORTED (i.e. always false)
 * @param {string[]} firstRoleArray - The lists of roles to allow selection of. Lowest access first. Normally all are in the same security compartment.
 * @param {string} title_opt - The optional title text to show next to the control. E.g. 'Role for Read'
 * @param {string} privilege - The privliege to grant to the selected role. E.g. read, update, delete
 */
com.marklogic.widgets.create.prototype.permissions = function(allowMultiple,firstRoleArray,title_opt,privilege) {
  if (undefined == privilege) {
    privilege = title_opt;
    title_opt = undefined;
  }

  // add permissions control
  var id = this.container + "-permissions-" + (++this.controlCount);
  var html = "&lt;div id='" + id + "' class='form-group input-prepend create-permissions'>";
  if (undefined != title_opt) {
    html += "&lt;label for='" + id + "-select' class='col-sm-2 control-label create-select-title'>" + title_opt + "&lt;/label> ";
  }
  html += "&lt;div class='col-sm-10'>";
  html += "&lt;select id='" + id + "-select' class='form-control create-select'>";

  for (var i = 0;i &lt; firstRoleArray.length;i++) {
    html += "&lt;option value='" + firstRoleArray[i] + "'>" + firstRoleArray[i] + "&lt;/option>";
  }

  html += "&lt;/select>&lt;/div>&lt;/div>";

  this._place(html,"permissions",id);
  this.controlData[id] = {privilege:privilege};
  return this;
};

/**
 * Generates a button bar as a full row below the current row.
 */
com.marklogic.widgets.create.prototype.bar = function() {
  var id = this.container + "-bar-" + ++this.controlCount;
  var html = "&lt;div id='" + id + "' class='create-bar'>&lt;/div>";
  this._place(html,"bar",id);

  // override placement strategy
  this.override = true;
  this.overrideElementId = id;
  this.overrideEndManual = true;

  return this;
};

/**
 * Ends the current bar, and adds any subsequent content to a new row.
 */
com.marklogic.widgets.create.prototype.endBar = function() {
  this.override = false;
  this.overrideEndManual = false;
  this.overrideElementId = "";

  //this._place("");

  return this;
};

/**
 * Generates a save button control at the current position.
 *
 * @param {string} title_opt - Optional string title to show on the button. (Defaults to 'Save')
 */
com.marklogic.widgets.create.prototype.save = function(title_opt) {
  var id = this.container + "-create-save-" + ++this.controlCount;
  var title = "Save";
  if (undefined != title_opt) {
    title = title_opt;
  }

  var html = "&lt;div class='col-sm-offset-2 col-sm-10'>&lt;button class='btn btn-primary create-save' type='submit' id='" + id + "'>" + title + "&lt;/button>&lt;/div>";
  this._place(html,"save",id);

  var self = this;
  //document.getElementById(id).onclick = function(e) {console.log("got onclick");self._onSave(self);console.log("done onsave");e.stopPropagation();console.log("done stop prop");return false;}; // TODO Check this is valid
  document.getElementById(this.container + "-create-form").onsubmit = function() {
    try {
      self._onSave();
    } catch (ex) {
      console.log("ERROR ON SAVE: " + ex);
    }
    return false;
  };
  // TODO find a way to do this without working at the form level

  return this;
};

// OTHER FIELD TYPES SUPPORTED

/*
fieldDef = {
  title: "Main Heading", path: "/h:body/h:h1[1]", namespaces: {h: "http://whatever"}, // also path: "some.json.path"
  type: "string|datetime|date|positiveInteger|integer|float|double", // basically any xs: intrinsic type
  required: true, min: 1, max: 7, default: 5, multiple: true // min max for numeric types, multiple for multi instance selects (for example)
}

// title defaults to CamelCase and split of last path element, type to string, required to false, multiple false, no namespaces
// thus only required field is path.
*/

com.marklogic.widgets.create.prototype.defaults = function(settings) {
  // set defaults used when creating shell fieldDef
    return this;
};

com.marklogic.widgets.create.prototype.text = function(fieldDef) {
  var id = this.container + "-text-" + ++this.controlCount;

  this._doccontext.completeFieldDef(fieldDef);

  var value = this._doccontext.getPart(fieldDef);
  if (null == value) {
    value = "";
  }
  var s = "&lt;div id='" + id + "' class='form-group input-prepend create-text-outer'>";
  s += "&lt;label for='" + id + "-input' class='col-sm-2 control-label create-text-label'>" + fieldDef.title + "&lt;/label>";
  s += "&lt;div class='col-sm-10'>";
  s += "&lt;input id='" + id + "-input' value='" + value + "' class='form-control create-text-input' />"; // TODO encode value for embedding in HTML
  s += "&lt;/div>";
  s += "&lt;/div>";

  // TODO if vertical, start row with label on left, field on right
  // TODO if horizontal, place label above field

  this._place(s,"text",id);

  // change event handler
  var el = document.getElementById(id + "-input");
  var self = this;
  el.onchange = function(evt) {
    self._doccontext.setPart(fieldDef,el.value);
  };

  return this;
};

com.marklogic.widgets.create.prototype.largeText = function(fieldDef) {
    var id = this.container + "-largetext-" + ++this.controlCount;

    this._doccontext.completeFieldDef(fieldDef);

    var value = this._doccontext.getPart(fieldDef);
    if (null == value) {
      value = "";
    }
    var s = "&lt;div id='" + id + "' class='form-group input-prepend create-largetext-outer'>";
    s += "&lt;label for='" + id + "-input' class='col-sm-2 control-label create-largetext-label'>" + fieldDef.title + "&lt;/label>";
    s += "&lt;div class='col-sm-10'>";
    s += "&lt;textarea id='" + id + "-input' class='form-control create-largetext-input'>" + value + "&lt;/textarea>"; // TODO encode value for embedding in HTML
    s += "&lt;/div>";
    s += "&lt;/div>";

    // TODO if vertical, start row with label on left, field on right
    // TODO if horizontal, place label above field

    this._place(s,"largetext",id);

    // change event handler
    var el = document.getElementById(id + "-input");
    var self = this;
    el.onchange = function(evt) {
      self._doccontext.setPart(fieldDef,el.value);
    };

    return this;
};

com.marklogic.widgets.create.prototype.largeHTML = function(fieldDef) {
    var id = this.container + "-largehtml-" + ++this.controlCount;

    this._doccontext.completeFieldDef(fieldDef);

    var value = this._doccontext.getPart(fieldDef);
    if (null == value) {
      value = "";
    }
    var s = "&lt;div id='" + id + "' class='form-group input-prepend create-largehtml-outer'>";
    s += "&lt;label for='" + id + "-input' class='col-sm-2 control-label create-largehtml-label'>" + fieldDef.title + "&lt;/label>";
    s += "&lt;div class='col-sm-10'>";
    s += "&lt;textarea id='" + id + "-input' class='form-control create-largehtml-input'>" + value + "&lt;/textarea>"; // TODO encode value for embedding in HTML
    s += "&lt;/div>";
    s += "&lt;/div>";

    // TODO if vertical, start row with label on left, field on right
    // TODO if horizontal, place label above field

    this._place(s,"largehtml",id);

    // initialise CKEditor
    var editor = CKEDITOR.replace(id + "-input");
    //fieldDef._html_editor = editor;

    // change event handler
    var self = this;
    /*
    var el = document.getElementById(id + "-input");
    el.onchange = function(evt) {
      self._doccontext.setPart(fieldDef,el.value);
    };*/
    editor.on('change', function() {
      self._doccontext.setPart(fieldDef,editor.getData());
    });

    return this;
};

com.marklogic.widgets.create.prototype.dropdown = function(fieldDef) {
  return this;

};

com.marklogic.widgets.create.prototype.date = function(fieldDef) {
  return this;

};

com.marklogic.widgets.create.prototype.dateTime = function(fieldDef) {
  return this;

};

com.marklogic.widgets.create.prototype.multiple = function(fieldDef) {
  return this;

};



// EVENT HANDLERS


/**
 * Adds a function as a listener to be called when this widget successfully generates a new document, passing in the new document's URI. If multiple documents are created, passes an array of string uris.
 *
 * @param {function} lis - The listener function to add. Function should accept a string uri
 */
com.marklogic.widgets.create.prototype.addCompleteListener = function(lis) {
  this.completePublisher.subscribe(lis);
};

/**
 * Removes a completion listener from this widget.
 *
 * @param {function} lis - The listener function to remove. Function should accept a string uri
 */
com.marklogic.widgets.create.prototype.removeCompleteListener = function(lis) {
  this.completePublisher.unsubscribe(lis);
};

com.marklogic.widgets.create.prototype._onSave = function() {
  console.log("onSave called");
  // loop through controls
  // create uploaded or new json/xml document with those fields
  // save document with specified uri or uri prefix, collection(s), permissions
  if ("upload" == this._mode) {
    // find file upload control and get document
    var uploadCtl = null;
    var perms = new Array();
    for (var i = 0;i &lt; this.controls.length;i++) {
      var ctl = this.controls[i];
      console.log("control: " + JSON.stringify(ctl));
      if ("dnd" == ctl.type) {
        uploadCtl = ctl;
      }
      // TODO extract other properties about this document
      if ("permissions" == ctl.type) {
        var ctlData = this.controlData[ctl.id];
        var e = document.getElementById(ctl.id + "-select");
        //console.log("selected value: " + e.value);
        //console.log("selected perm: " + e.selectedIndex);
        //console.log("selected perm value: " + e.options[e.selectedIndex]);
        //var str = e.options[e.selectedIndex].text;
        //console.log("adding permission: " + e.value + " = read");
        perms.push({role: e.value, permission: ctlData.privilege});
        //perms.push({role: e.value + "-write", permission: "insert"});
        //perms.push({role: e.value + "-write", permission: "update"});
        //perms.push({role: "can-read", permission: "read"});
      }
    }

    // add forced permissions
    for (var p = 0;p &lt; this._permissions.length;p++) {
      perms.push(this._permissions[p]);
    }

    if (null != uploadCtl) {
      console.log("got uploadCtl");


      /*
      // get file info for upload
      var reader = new FileReader();
      //var files = this.controlData[uploadCtl.id].files;
      //var file = files[0]; // TODO handle multiple, none
      console.log("fetching file")
      var fileel = document.getElementById(uploadCtl.id);
      var file = fileel.files[0];
      console.log("reading file");

      var self = this;

      reader.onload = (function(theFile) {

      var bin = reader.readAsArrayBuffer(theFile);
      console.log("BIN RESULT: " + bin);
      console.log("Reader info: " + JSON.stringify(reader));

        return function(e) {
          var res = e.target.result; // WRONG - THIS IS SENDING BYTE LENGTH ONLY
          console.log("TARGET JSON: " + JSON.stringify(e));
          //
          for (var n in fileel) {
            console.log(" " + n);
            console.log("  " + n + ": " + typeof(fileel[n]));
          }//
          console.log("result: " + JSON.stringify(res));
          var cols = "";
          for (var i = 0;i &lt; self._collections.length;i++) {
            if (0 != i) {
              cols += ",";
            }
            cols += self._collections[i];
          }
          // send as octet stream, filename for after URI prefix
          console.log("calling mljs save");
          var props = {
            contentType: file.type,
            collection: cols,
            permissions: perms
          }
          console.log("mime type: " + file.type);
          console.log("Request properties: " + JSON.stringify(props));
          mljs.defaultconnection.save(res,self._uriprefix + file.name,props,function(result) {
            if (result.inError) {
              console.log("ERROR: " + result.doc);
            } else {
              console.log("SUCCESS: " + result.docuri);
              self.completePublisher.publish(result.docuri);
            }
          });
        }
      })(file);

      */





    var files = document.getElementById(uploadCtl.id).files;
    if (!files.length) {
      alert('Please select a file!');
      return;
    }

    var file = files[0];
    var start = 0;
    var stop = file.size - 1;


          var cols = "";
          for (var i = 0;i &lt; this._collections.length;i++) {
            if (0 != i) {
              cols += ",";
            }
            cols += this._collections[i];
          }

          var props = {
            contentType: file.type,
            //contentType: false,
            format: "binary",
            collection: cols,
            permissions: perms
          }
          console.log("mime type: " + file.type);
          console.log("Request properties: " + JSON.stringify(props));

    var reader = new FileReader();
    var self = this;

    // If we use onloadend, we need to check the readyState.
    reader.onloadend = function(evt) {
      if (evt.target.readyState == FileReader.DONE) { // DONE == 2
        //document.getElementById('byte_content').textContent = evt.target.result;

        console.log("file content: " + evt.target.result);

        // save to ML

        console.log("calling mljs save");
          /*
          var arrBuff = new ArrayBuffer(evt.target.result.length);
          var writer = new Uint8Array(arrBuff);
          for (var i = 0, len = evt.target.result.length; i &lt; len; i++) {
              writer[i] = evt.target.result.charCodeAt(i);
          }*/

          mljs.defaultconnection.save(file,self._uriprefix + file.name,props,function(result) {
            if (result.inError) {
              console.log("ERROR: " + result.doc);
            } else {
              console.log("SUCCESS: " + result.docuri);
              self.completePublisher.publish(result.docuri);
            }
          });




        /*document.getElementById('byte_range').textContent =
            ['Read bytes: ', start + 1, ' - ', stop + 1,
             ' of ', file.size, ' byte file'].join('');*/
      }
    };

    var blob = null;
    if (file.webkitSlice) {
      blob = file.webkitSlice(start, stop + 1);
    } else if (file.mozSlice) {
      blob = file.mozSlice(start, stop + 1);
    }
    //reader.readAsBinaryString(blob);
    reader.readAsArrayBuffer(blob);
    //reader.readAsText(file);

    } else {
      // TODO
      console.log("upload ctl null");
    }
  } else if (this._mode == "xml" || this._mode == "json") {
    // call doccontext save (assume all fields already updated)
    this._doccontext.save();
  } else {
    // TODO
    console.log("unknown mode: " + this._mode);
  }
};
</pre>
        </article>
    </section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					MLJS - A JavaScript wrapper for the MarkLogic REST API
					<br />
					
					
		<span class="copyright">
		MarkLogic 2012-2014
		</span>
					<br />
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.3-dev</a>
		on Wed Aug 20 2014 13:08:22 GMT+0100 (BST) using the <a href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<script src="scripts/sunlight.js"></script>
	<script src="scripts/sunlight.javascript.js"></script>
	<script src="scripts/sunlight-plugin.doclinks.js"></script>
	<script src="scripts/sunlight-plugin.linenumbers.js"></script>
	<script src="scripts/sunlight-plugin.menu.js"></script>
	<script src="scripts/jquery.min.js"></script>
	<script src="scripts/jquery.scrollTo.js"></script>
	<script src="scripts/jquery.localScroll.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>


	<script>  Sunlight.highlightAll({lineNumbers:true,  showMenu: true, enableDoclinks :true}); </script>

	<script>
		$( function () {
			$( "#toc" ).toc( {
			    anchorName  : function(i, heading, prefix) {
					return $(heading).attr("id") || ( prefix + i );
				},
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : 60
			} );
			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );

		} );
	</script>

	

</body>
</html>
