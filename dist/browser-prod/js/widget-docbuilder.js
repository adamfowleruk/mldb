
com=window.com||{};com.marklogic=window.com.marklogic||{};com.marklogic.widgets=window.com.marklogic.widgets||{};com.marklogic.widgets.create=function(container){this.container=container;this.errorPublisher=new com.marklogic.events.Publisher();this.vertical=true;this._collections=new Array();this._permissions=new Array();this.currentRow=0;this.currentColumn=0;this.completePublisher=new com.marklogic.events.Publisher();this.controlCount=0;this.fileDrops=new Array();this.fileDropFiles=new Array();this.override=false;this.overrideEndManual=false;this.overrideElementId="";this._doccontext=null;this._uriprefix="/";this.controls=new Array();this.controlData=new Array();this._mode="upload";this._init();};com.marklogic.widgets.create.prototype.setDocumentContext=function(ctx){this._doccontext=ctx;};com.marklogic.widgets.create.prototype.updateDocumentContent=function(json){var uri=json.docuri;var content=json.doc;var t=document.getElementById(this.container+"-title");t.innerHTML="Editing document - <i>"+uri+"</i>";};com.marklogic.widgets.create.prototype.addErrorListener=function(fl){this.errorPublisher.subscribe(fl);};com.marklogic.widgets.create.prototype.removeErrorListener=function(fl){this.errorPublisher.unsubscribe(fl);};com.marklogic.widgets.create.prototype._init=function(){var parentel=document.getElementById(this.container);parentel.innerHTML="<div id='"+this.container+"-create' class='mljswidget panel panel-info create'>"+"<div id='"+this.container+"-title' class='panel-heading create-title'>Create a new Document</div>"+"<form id='"+this.container+"-create-form' class='panel-body form-horizontal create-form' role='form'>"+"<div class='create-row' id='"+this.container+"-create-row-0'>"+"<div class='create-col' id='"+this.container+"-create-row-0-col-0' style='float:left;'></div>"+"</div>"+"</form>""</div><div style='";};com.marklogic.widgets.create.prototype._place=function(html,type,id){if(this.override){com.marklogic.widgets.appendHTML(document.getElementById(this.overrideElementId),html);}else{var cid=this.container+"-create-row-"+this.currentRow+"-col-"+this.currentColumn;var cel=document.getElementById(cid);cel.innerHTML=html;if(this.vertical){this.endRow();}else{this.currentColumn++;var h="<div class='create-col' id='"+this.container+"-create-row-"+this.currentRow+"-col-"+this.currentColumn+"' style='float:left;'></div>";com.marklogic.widgets.appendHTML(document.getElementById(this.container+"-create-row-"+this.currentRow),h);}}
if(undefined!=type&&undefined!=id){this.controls.push({type:type,id:id});}};com.marklogic.widgets.create.prototype.endRow=function(){com.marklogic.widgets.appendHTML(document.getElementById(this.container+"-create-row-"+this.currentRow),"<div style='clear:both'></div>");this.currentRow++;this.currentColumn=0;var h="<div class='create-row' id='"+this.container+"-create-row-"+this.currentRow+"'>"+"<div class='create-col' id='"+this.container+"-create-row-"+this.currentRow+"-col-"+this.currentColumn+"' style='float:left;'></div>"+"</div>";com.marklogic.widgets.appendHTML(document.getElementById(this.container+"-create-form"),h);return this;};com.marklogic.widgets.create.prototype.mode=function(newMode){this._mode=newMode;return this;};com.marklogic.widgets.create.prototype.uriPrefix=function(prefix){this._uriprefix=prefix;return this;};com.marklogic.widgets.create.prototype.uriprefix=com.marklogic.widgets.create.prototype.uriPrefix;com.marklogic.widgets.create.prototype.horizontal=function(){this.vertical=false;return this;};com.marklogic.widgets.create.prototype.collectionUser=function(){return this;};com.marklogic.widgets.create.prototype.collection=function(col){this._collections.push(col);return this;};com.marklogic.widgets.create.prototype.dnd=function(){if(window.File&&window.FileReader&&window.FileList&&window.Blob){console.log("File API is supported by this browser");}else{console.log('The File APIs are not fully supported in this browser.');}
var id=this.container+"-dnd-"+ ++this.controlCount;var html="<input type='file' id='"+id+"' class='span2 form-control btn btn-default create-file' />";this._place(html,"dnd",id);var self=this;document.getElementById(id).onchange=function(evt){console.log("file onchange fired");self.controlData[id]={files:evt.target.files};console.log("Saved file data");};return this;};com.marklogic.widgets.create.prototype.forcePermission=function(permObject){this._permissions.push(permObject);return this;};com.marklogic.widgets.create.prototype.permissions=function(allowMultiple,firstRoleArray,title_opt,privilege){if(undefined==privilege){privilege=title_opt;title_opt=undefined;}
var id=this.container+"-permissions-"+(++this.controlCount);var html="<div id='"+id+"' class='form-group input-prepend create-permissions'>";if(undefined!=title_opt){html+="<label for='"+id+"-select' class='col-sm-2 control-label create-select-title'>"+title_opt+"</label> ";}
html+="<div class='col-sm-10'>";html+="<select id='"+id+"-select' class='form-control create-select'>";for(var i=0;i<firstRoleArray.length;i++){html+="<option value='"+firstRoleArray[i]+"'>"+firstRoleArray[i]+"</option>";}
html+="</select></div></div>";this._place(html,"permissions",id);this.controlData[id]={privilege:privilege};return this;};com.marklogic.widgets.create.prototype.bar=function(){var id=this.container+"-bar-"+ ++this.controlCount;var html="<div id='"+id+"' class='create-bar'></div>";this._place(html,"bar",id);this.override=true;this.overrideElementId=id;this.overrideEndManual=true;return this;};com.marklogic.widgets.create.prototype.endBar=function(){this.override=false;this.overrideEndManual=false;this.overrideElementId="";return this;};com.marklogic.widgets.create.prototype.save=function(title_opt){var id=this.container+"-create-save-"+ ++this.controlCount;var title="Save";if(undefined!=title_opt){title=title_opt;}
var html="<div class='col-sm-offset-2 col-sm-10'><button class='btn btn-primary create-save' type='submit' id='"+id+"'>"+title+"</button></div>";this._place(html,"save",id);var self=this;document.getElementById(this.container+"-create-form").onsubmit=function(){try{self._onSave();}catch(ex){console.log("ERROR ON SAVE: "+ex);}
return false;};return this;};com.marklogic.widgets.create.prototype.defaults=function(settings){return this;};com.marklogic.widgets.create.prototype.text=function(fieldDef){var id=this.container+"-text-"+ ++this.controlCount;this._doccontext.completeFieldDef(fieldDef);var value=this._doccontext.getPart(fieldDef);if(null==value){value="";}
var s="<div id='"+id+"' class='form-group input-prepend create-text-outer'>";s+="<label for='"+id+"-input' class='col-sm-2 control-label create-text-label'>"+fieldDef.title+"</label>";s+="<div class='col-sm-10'>";s+="<input id='"+id+"-input' value='"+value+"' class='form-control create-text-input' />";s+="</div>";s+="</div>";this._place(s,"text",id);var el=document.getElementById(id+"-input");var self=this;el.onchange=function(evt){self._doccontext.setPart(fieldDef,el.value);};return this;};com.marklogic.widgets.create.prototype.largeText=function(fieldDef){var id=this.container+"-largetext-"+ ++this.controlCount;this._doccontext.completeFieldDef(fieldDef);var value=this._doccontext.getPart(fieldDef);if(null==value){value="";}
var s="<div id='"+id+"' class='form-group input-prepend create-largetext-outer'>";s+="<label for='"+id+"-input' class='col-sm-2 control-label create-largetext-label'>"+fieldDef.title+"</label>";s+="<div class='col-sm-10'>";s+="<textarea id='"+id+"-input' class='form-control create-largetext-input'>"+value+"</textarea>";s+="</div>";s+="</div>";this._place(s,"largetext",id);var el=document.getElementById(id+"-input");var self=this;el.onchange=function(evt){self._doccontext.setPart(fieldDef,el.value);};return this;};com.marklogic.widgets.create.prototype.largeHTML=function(fieldDef){var id=this.container+"-largehtml-"+ ++this.controlCount;this._doccontext.completeFieldDef(fieldDef);var value=this._doccontext.getPart(fieldDef);if(null==value){value="";}
var s="<div id='"+id+"' class='form-group input-prepend create-largehtml-outer'>";s+="<label for='"+id+"-input' class='col-sm-2 control-label create-largehtml-label'>"+fieldDef.title+"</label>";s+="<div class='col-sm-10'>";s+="<textarea id='"+id+"-input' class='form-control create-largehtml-input'>"+value+"</textarea>";s+="</div>";s+="</div>";this._place(s,"largehtml",id);var editor=CKEDITOR.replace(id+"-input");var self=this;editor.on('change',function(){self._doccontext.setPart(fieldDef,editor.getData());});return this;};com.marklogic.widgets.create.prototype.dropdown=function(fieldDef){return this;};com.marklogic.widgets.create.prototype.date=function(fieldDef){return this;};com.marklogic.widgets.create.prototype.dateTime=function(fieldDef){return this;};com.marklogic.widgets.create.prototype.multiple=function(fieldDef){return this;};com.marklogic.widgets.create.prototype.addCompleteListener=function(lis){this.completePublisher.subscribe(lis);};com.marklogic.widgets.create.prototype.removeCompleteListener=function(lis){this.completePublisher.unsubscribe(lis);};com.marklogic.widgets.create.prototype._onSave=function(){console.log("onSave called");if("upload"==this._mode){var uploadCtl=null;var perms=new Array();for(var i=0;i<this.controls.length;i++){var ctl=this.controls[i];console.log("control: "+JSON.stringify(ctl));if("dnd"==ctl.type){uploadCtl=ctl;}
if("permissions"==ctl.type){var ctlData=this.controlData[ctl.id];var e=document.getElementById(ctl.id+"-select");perms.push({role:e.value,permission:ctlData.privilege});}}
for(var p=0;p<this._permissions.length;p++){perms.push(this._permissions[p]);}
if(null!=uploadCtl){console.log("got uploadCtl");var files=document.getElementById(uploadCtl.id).files;if(!files.length){alert('Please select a file!');return;}
var file=files[0];var start=0;var stop=file.size-1;var cols="";for(var i=0;i<this._collections.length;i++){if(0!=i){cols+=",";}
cols+=this._collections[i];}
var props={contentType:file.type,format:"binary",collection:cols,permissions:perms}
console.log("mime type: "+file.type);console.log("Request properties: "+JSON.stringify(props));var reader=new FileReader();var self=this;console.log("got file reader instance");reader.onloadend=function(evt){console.log("in reader.onloadend with status: "+evt.target.readyState);if(evt.target.readyState==FileReader.DONE){console.log("file content: "+evt.target.result);console.log("calling mljs save");mljs.defaultconnection.save(file,self._uriprefix+file.name,props,function(result){if(result.inError){console.log("ERROR: "+result.doc);}else{console.log("SUCCESS: "+result.docuri);self.completePublisher.publish(result.docuri);}});}};var blob=null;if(file.webkitSlice){blob=file.webkitSlice(start,stop+1);}else if(file.mozSlice){blob=file.mozSlice(start,stop+1);}else{blob=file;}
console.log("reading as array: file: "+blob);reader.readAsArrayBuffer(blob);console.log("after read as array");}else{console.log("upload ctl null");}}else if(this._mode=="xml"||this._mode=="json"){this._doccontext.save();}else{console.log("unknown mode: "+this._mode);}};com.marklogic.widgets.workplaceadminext=window.com.marklogic.widgets.workplaceadminext||{};com.marklogic.widgets.workplaceadminext.widgets=window.com.marklogic.widgets.workplaceadminext.widgets||{};com.marklogic.widgets.workplaceadminext.widgets["widget-docbuilder.js"]=[{title:"Upload",classname:"com.marklogic.widgets.upload",description:"Document upload widget."}];com.marklogic.widgets.upload=function(container){this.container=container;this._config={forwardUrl:"/view.html5?uri=#URI#",readClasses:[],writeClasses:[],uriPrefix:"/uploads/",collections:[{collection:"uploads"}]};this._documentContext=null;this._createWidget=null;this._init();};com.marklogic.widgets.upload.getConfigurationDefinition=function(){return{uriPrefix:{type:"string",default:"/uploads/",title:"URI Prefix",description:"The URI prefix to give to the uploaded file."},collections:{type:"multiple",minimum:0,default:[{collection:"uploads"}],title:"Collections",description:"The collections to add uploaded documents to.",childDefinitions:{collection:{type:"string",default:"",title:"Collection",description:"Collection name."}}},readClasses:{type:"multiple",minimum:0,default:[],title:"Read Roles",description:"Roles permitted to read this document.",childDefinitions:{role:{type:"string",default:"",title:"Role",description:"The MarkLogic Server role name."}}},writeClasses:{type:"multiple",minimum:0,default:[],title:"Update Roles",description:"Roles permitted to update this document.",childDefinitions:{role:{type:"string",default:"",title:"Role",description:"The MarkLogic Server role name."}}},forwardUrl:{type:"string",default:"/view.html5?uri=#URI#",title:"Forward URL",description:"Where to send the user on successful upload."}};};com.marklogic.widgets.upload.prototype.setConfiguration=function(config){for(var prop in config){this._config[prop]=config[prop];}
this._refresh();if(null!=this._createWidget&&null!=this._documentContext){this._documentContext.register(this._createWidget);}};com.marklogic.widgets.upload.prototype.setDocumentContext=function(dc){this._documentContext=dc;if(null!=this._createWidget){this._documentContext.register(this._createWidget);}};com.marklogic.widgets.upload.prototype._init=function(){var s="<div class='mljswidget upload' id='"+this.container+"-outer'><div id='"+this.container+"-notifications'></div><div id='"+this.container+"-inner'></div></div>";document.getElementById(this.container).innerHTML=s;this._refresh();};com.marklogic.widgets.upload.prototype._refresh=function(){if(window.File&&window.FileReader&&window.FileList&&window.Blob){}else{document.getElementById(this.container+"-notifications").innerHTML='<p>The File APIs are not fully supported in this browser.</p>';}
var wgt=new com.marklogic.widgets.create(this.container+"-inner");var writeClasses=new Array();var readClasses=new Array();for(var r=0,maxr=this._config.readClasses.length,cl;r<maxr;r++){cl=this._config.readClasses[r];readClasses.push(cl.role);}
for(var r=0,maxr=this._config.writeClasses.length,cl;r<maxr;r++){cl=this._config.writeClasses[r];writeClasses.push(cl.role);}
this._createWidget=wgt;wgt.uriprefix(this._config.uriPrefix).collectionUser().horizontal().dnd().permissions(false,readClasses,"Reader Level","read").permissions(false,writeClasses,"Modifier Level","update").endRow().bar().save("Upload").endBar().endRow();for(var c=0,maxc=this._config.collections.length,col;c<maxc;c++){col=this._config.collections[c];wgt.collection(col.collection);}
var self=this;wgt.addCompleteListener(function(evt){document.getElementById(self.container+"-notifications").innerHTML="<p>Created doc with uri: "+evt+"</p>";if(null!=self._config.forwardUrl&&""!=self._config.forwardUrl.trim()){var loc=self._config.forwardUrl.replace("#URI#",encodeURI(evt));window.location=loc;}});};