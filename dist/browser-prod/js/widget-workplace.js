
com=window.com||{};com.marklogic=window.com.marklogic||{};com.marklogic.widgets=window.com.marklogic.widgets||{};com.marklogic.widgets.workplace=function(container){this.container=container;this._configurationContext=new mljs.defaultconnection.configurationcontext(this);this._editable=false;this._contexts=new Array();this._widgets={};this._classInstances={};this._workplaceContext=new com.marklogic.widgets.workplacecontext();this._loadedPublisher=new com.marklogic.events.Publisher();this._init();this._workplaceContext.register(this);};com.marklogic.widgets.workplace.prototype.getWorkplaceContext=function(){return this._workplaceContext;};com.marklogic.widgets.workplace.prototype.setWorkplaceContext=function(ctx){this._workplaceContext=ctx;this.updateWorkplace();};com.marklogic.widgets.workplace.prototype._init=function(){var str="<div id='"+this.container+"-container' class='workplace-container'>";str+=" <div id='"+this.container+"-layout'></div>";str+=" <div id='"+this.container+"-mask' class='workplace-mask'>";str+="  <div class='workplace-mask-icon' ><img id='"+this.container+"-link' src='/images/mljs/setting-small.png' title='Edit this Workplace' class='workplace-edit-link' /></div>";str+=" </div>";str+="</div>";document.getElementById(this.container).innerHTML=str;var self=this;document.getElementById(this.container+"-link").onclick=function(evt){com.marklogic.widgets.workplaceadmin.renderFullscreen(self._workplaceContext);};};com.marklogic.widgets.workplace.prototype.editable=function(editme){if(undefined==editme){editme=true;}
this._editable=editme;if(this._editable){document.getElementById(this.container+"-mask").style.display="block";}else{document.getElementById(this.container+"-mask").style.display="none";}};com.marklogic.widgets.workplace.prototype.loadPage=function(jsonOrString,json_opt){this._workplaceContext.loadPage(jsonOrString,json_opt);};com.marklogic.widgets.workplace.prototype.getInstance=function(instanceName){return this._widgets[instanceName]||this._contexts[instanceName];};com.marklogic.widgets.workplace.prototype.addPageLoadedListener=function(lis){this._loadedPublisher.subscribe(lis);};com.marklogic.widgets.workplace.prototype.removePageLoadedListener=function(lis){this._loadedPublisher.unsubscribe(lis);};com.marklogic.widgets.workplace.prototype.updateWorkplace=function(context){mljs.defaultconnection.logger.debug("workplace.updateWorkplace: UPDATING PAGE");var json=this._workplaceContext.getJson();mljs.defaultconnection.logger.debug("workplace.updateWorkplace: Creating layout");var layout=new(com.marklogic.widgets.layouts[json.layout]||com.marklogic.widgets.layoutsext[json.layout])(this.container+"-layout");mljs.defaultconnection.logger.debug("workplace.updateWorkplace: Creating zones");layout.createZones(json.assignments);var self=this;var getInstance=function(widgetName){return self.getInstance(widgetName);};var contexts={};mljs.defaultconnection.logger.debug("workplace.updateWorkplace: Creating contexts");for(var c=0,max=json.contexts.length,ctx;c<max;c++){ctx=json.contexts[c];mljs.defaultconnection.logger.debug("workplace.updateWorkplace: Context: "+c+" is "+JSON.stringify(ctx));var inst=this._workplaceContext.getContextInstance(ctx.type);this._configurationContext.register(inst);contexts[ctx.context]=inst;mljs.defaultconnection.logger.debug("workplace.updateWorkplace: Is context instance valid?: is object?: "+(typeof inst));var instances=this._classInstances[ctx.type];if(undefined==instances){instances=[];this._classInstances[ctx.type]=instances;}
instances.push(inst);}
this._contexts=contexts;for(var c=0,max=json.contexts.length,ctx;c<max;c++){ctx=json.contexts[c];var inst=contexts[ctx.context];mljs.defaultconnection.logger.debug("workplace.updateWorkplace: Config: "+JSON.stringify(ctx.config));if(undefined!=inst.setConfiguration&&undefined!=ctx.config){mljs.defaultconnection.logger.debug("workplace.updateWorkplace: Setting context configuration");var nc=JSON.parse(JSON.stringify(ctx.config));nc.getInstance=getInstance;inst.setConfiguration(nc);}}
var widgets={};mljs.defaultconnection.logger.debug("workplace.updateWorkplace: Creating widget instances");for(var w=0,max=json.widgets.length,widget;w<max;w++){widget=json.widgets[w];mljs.defaultconnection.logger.debug("workplace.updateWorkplace: Creating widget: "+w+" with: "+JSON.stringify(widget));var item=layout.getAssignmentByWidgetName(widget.widget).item;var elementid=item.elementid;var nc=JSON.parse(JSON.stringify(widget.config));nc.getInstance=getInstance;var wgt=this._createWidget(widget.type,elementid,nc,widget.widget);mljs.defaultconnection.logger.debug("workplace.updateWorkplace: Create widget has returned");widgets[widget.widget]=wgt;var instances=this._classInstances[widget.type];if(undefined==instances){instances=[];this._classInstances[widget.type]=instances;}
instances.push(wgt);}
this._widgets=widgets;if(undefined!=json.actions&&undefined!=json.actions.onload){mljs.defaultconnection.logger.debug("workplace.updateWorkplace: Processing onload actions ("+json.actions.onload.length+")");for(var a=0,max=json.actions.onload.length,action;a<max;a++){action=json.actions.onload[a];mljs.defaultconnection.logger.debug("workplace.updateWorkplace: Processing onload action: "+JSON.stringify(action));var actionObject=new(com.marklogic.widgets.actions[action.type])();mljs.defaultconnection.logger.debug("workplace.updateWorkplace: Got instance. Calling setConfiguration()...");var nc=JSON.parse(JSON.stringify(action.config));nc.getInstance=getInstance;actionObject.setConfiguration(nc);mljs.defaultconnection.logger.debug("workplace.updateWorkplace: Finished configuring. Caling execute(this)...");var result=actionObject.execute(this);}
mljs.defaultconnection.logger.debug("workplace.updateWorkplace: COMPLETE processing onload actions");}
mljs.defaultconnection.logger.debug("workplace.updateWorkplace: finished loading page");this._loadedPublisher.publish(this._workplaceContext);};com.marklogic.widgets.workplace.prototype.getContextObject=function(name){return this._contexts[name];};com.marklogic.widgets.workplace._getWidgetClass=function(type){var wobj=com;var splits=type.split(".");for(var i=1,max=splits.length,split;i<max;i++){split=splits[i];wobj=wobj[split];}
return wobj;};com.marklogic.widgets.workplace.prototype._createWidget=function(type,elementid,config,name){mljs.defaultconnection.logger.debug("workplace._createWidget: Creating widget: "+type+" in "+elementid+" with config: "+JSON.stringify(config));var wobj=com.marklogic.widgets.workplace._getWidgetClass(type);mljs.defaultconnection.logger.debug("workplace._createWidget: instantiating widget: "+JSON.stringify(wobj));var wgt=new wobj(elementid);mljs.defaultconnection.logger.debug("workplace._createWidget: has widget instance been created? type is object?: "+(typeof wgt));if(undefined!==this._configurationContext){this._configurationContext.register(wgt);}
var json=this._workplaceContext.getJson();var getContext=function(cn){for(var c=0,maxc=json.contexts.length,ct;c<maxc;c++){ct=json.contexts[c];if(ct.context==cn){return ct;}}
return null;};for(var ctxname in this._contexts){var ctxconfig=getContext(ctxname);var ctx=this._contexts[ctxname];if(ctxconfig.register.contains(name)){ctx.register(wgt);}}
if(undefined!==wgt.setConfiguration){wgt.setConfiguration(config);}
return wgt;};com.marklogic.widgets.workplace.prototype.getInstance=function(name){var ins=this._contexts[name];if(null==ins){ins=this._widgets[name];}
return ins;};com.marklogic.widgets.workplace.prototype.getInstancesOf=function(cname){return this._classInstances[cname];};com.marklogic.widgets.layouts={};com.marklogic.widgets.layouts.helper={};com.marklogic.widgets.layouts.helper.prune=function(assignmentArray){};com.marklogic.widgets.layouts.helper.extendLayout=function(layoutInstance,container,zones){var self=layoutInstance;self.container=container;self.zones={};self.zoneNames=zones;for(var i=0,max=zones.length,zone;i<max;i++){zone=zones[i];self.zones[zone]=new Array();}
self._nextID=1;self.getAssignmentByWidgetName=function(widgetname){return self._overZones(function(item){if(undefined!=item&&"object"==typeof(item)){if(item.widget==widgetname){return true;}}
return false;});};self._overZones=function(matcher){for(var z in self.zones){mljs.defaultconnection.logger.debug("_overZones: fetching zone named: "+z);var zone=self.zones[z];if(undefined!=zone){mljs.defaultconnection.logger.debug("_overZones: Looping through zone containers");mljs.defaultconnection.logger.debug("_overZones: typeof zone: "+typeof(zone));for(var i=1,max=zone.length,item;i<max;i++){item=zone[i];mljs.defaultconnection.logger.debug("_overZones: got container number "+i+" with item type: "+typeof(item));if("object"==typeof(item)){mljs.defaultconnection.logger.debug("_overZones: item json content: "+JSON.stringify(item));}
if(matcher(item)){var mj={item:item,zone:z,order:i};mljs.defaultconnection.logger.debug("_overZones: Container "+i+" matches. Returning match JSON: "+JSON.stringify(mj));return mj;}}}}
mljs.defaultconnection.logger.debug("_overZones: No zone container matches at all. Returning null");return null;};self.getAssignmentByPlaceholder=function(elid){mljs.defaultconnection.logger.debug("getAssignmentByPlaceholder: Called for elid: "+elid);return self._overZones(function(item){mljs.defaultconnection.logger.debug("getAssignmentByPlaceholder: overzones matcher called for elid: "+elid);if(undefined!=item){if("string"==typeof(item)){mljs.defaultconnection.logger.debug("getAssignmentByPlaceholder: item is string");if(item==elid){mljs.defaultconnection.logger.debug("getAssignmentByPlaceholder: string item '"+item+"' matches elid");return true;}}else{mljs.defaultconnection.logger.debug("getAssignmentByPlaceholder: item is JSON config");if(item.elementid==elid){mljs.defaultconnection.logger.debug("getAssignmentByPlaceholder: JSON config '"+item.elementid+"' matches elid");return true;}}}else{}
mljs.defaultconnection.logger.debug("getAssignmentByPlaceholder: item not a match for elid. returning false");return false;})};self.getZoneList=function(){return self.zoneNames;};self.createZones=function(assignments){mljs.defaultconnection.logger.debug("Creating zones in thinthick layout");if(undefined!=assignments){for(var i=0,max=assignments.length,ass;i<max;i++){mljs.defaultconnection.logger.debug("layout<class>.createZones: i: "+i);ass=assignments[i];mljs.defaultconnection.logger.debug("layout<class>.createZones: i: "+i+" has ass: "+JSON.stringify(ass));self.zones[ass.zone][ass.order]=ass;}}
for(var zone in self.zones){self._genZones(zone,self.zones[zone]);}};self._getZone=function(zone){var z=self.zones[zone];if(undefined==z){z=[];self.zones[zone]=z;}
return z;};self.printZoneInfo=function(){var l=mljs.defaultconnection.logger.debug;for(var z in self.zones){var zone=self.zones[z];for(var i=0,max=zone.length,element;i<max;i++){element=zone[i];if(undefined!=element){if("string"==typeof(element)){l("layout.printZoneInfo: Zone: "+z+", index: "+i+", contains: Placeholder: "+element);}else{l("layout.printZoneInfo: Zone: "+z+", index: "+i+", contains: Widget: "+element.widget);}}}}};self._elementAt=function(zone,index){var z=self.zones[zone];if(undefined==z){return null;}
return z[index];};self.generateAssignments=function(){var ass=[];for(var zone in self.zones){var z=self.zones[zone];var nextOrder=1;self._eliminateBlanks(z);for(var o=2,max=z.length,wgt;o<max;o+=2){wgt=z[o];if(undefined!=z[o]){ass.push({widget:wgt.widget,zone:zone,order:(nextOrder++)});}}}
return ass;};self.createPlaceholder=function(zone){var lastOrder=self.zones[zone].length;if(0==lastOrder){lastOrder=1;}
var elid=self.container+"-"+zone+"-"+self._nextID++;self.zones[zone][lastOrder]=elid;if(undefined!=self._createPlaceholderHTMLOverride){self._createPlaceholderHTMLOverride(zone,elid);}else{var zoneel=document.getElementById(self.container+"-"+zone);var div=document.createElement("div");div.setAttribute("id",elid);zoneel.appendChild(div);}
return elid;};self.registerAssignment=function(placeholderelid,assignmentJsonOrWidgetName){var info=self.getAssignmentByPlaceholder(placeholderelid);if("string"==typeof(assignmentJsonOrWidgetName)){assignmentJsonOrWidgetName={widget:assignmentJsonOrWidgetName};}
self.zones[info.zone][info.order]=assignmentJsonOrWidgetName;assignmentJsonOrWidgetName.elementid=placeholderelid;assignmentJsonOrWidgetName.order=info.order;assignmentJsonOrWidgetName.zone=info.zone;return assignmentJsonOrWidgetName;};self._genZones=function(zone,arr){mljs.defaultconnection.logger.debug("layout<class>._genZones: "+zone+" with array: "+JSON.stringify(arr));for(var i=1,max=arr.length,ass;i<max;i++){mljs.defaultconnection.logger.debug("layout<class>._genZones: zone: "+zone+" index: "+i);ass=arr[i];if(undefined!=ass){var elid=self.createPlaceholder(zone);var newAss=self.registerAssignment(elid,ass);}}};self.remove=function(widgetName){var me=self.getAssignmentByWidgetName(widgetName).item;var spacer=self._elementAt(me.zone,me.order-1);var z=self.zones[me.zone];var lastWWithWidget=0;for(var w=1,maxw=z.length,moveme;w<z.length;w++){moveme=z[w];if(undefined!=moveme){lastWWithWidget=w;if(moveme.order>me.order){z[w-2]=moveme;moveme.order=w-2;z[w]=undefined;}}}
z[lastWWithWidget-1]=undefined;z[lastWWithWidget]=undefined;self._eliminateBlanks(z);var meel=document.getElementById(me.elementid);meel.parentNode.removeChild(meel);if(undefined!=spacer){var spacerel=document.getElementById(spacer.elementid);if(undefined!=spacerel){spacerel.parentNode.removeChild(spacerel);}}};self.moveToPosition=function(widgetName,newZone,newIndexOneBased){var z=self.zones[newZone];self._eliminateBlanks(z);mljs.defaultconnection.logger.debug("layout<subclass>.moveToPosition: Entered");var wgt=self._elementAt(newZone,newIndexOneBased);var me=self.getAssignmentByWidgetName(widgetName).item;var spacer=self._elementAt(me.zone,me.order-1);var oldZone=me.zone;if(undefined!=oldZone){var zOldZone=self.zones[oldZone];self._eliminateBlanks(zOldZone);}
var oldOrder=me.order;mljs.defaultconnection.logger.debug("layout<subclass>.moveToPosition: Got Widget at target position. Moving those afterwards");var lastWidget=null;for(var w=z.length-1,min=0,moveme;w>=min&&null==lastWidget;w--){moveme=z[w];if(undefined!=moveme){lastWidget=moveme;}}
if(undefined==newIndexOneBased){lastWidget=z[lastWidget.order-2];wgt=lastWidget;newIndexOneBased=wgt.order;var lastWidgetPos=wgt.order;z[me.order+1]=wgt;z[lastWidgetPos]=undefined;wgt.order=me.order+1;z[lastWidgetPos]=spacer;spacer.order=lastWidgetPos;z[lastWidgetPos+1]=me;me.order=lastWidgetPos+1;z[lastWidgetPos+2]=wgt;wgt.order=lastWidgetPos+2;z[lastWidgetPos+3]=undefined;}else{if(null!=wgt){if(null!=lastWidget&&lastWidget.elementid==wgt.elementid){}else{for(var w=z.length-1,min=newIndexOneBased,moveme;w>=min;w--){moveme=z[w];if(undefined!=moveme){moveme.order+=2;z[w+2]=moveme;z[w]=undefined;}}}}
mljs.defaultconnection.logger.debug("layout<subclass>.moveToPosition: Getting widget to move");me.order=newIndexOneBased+1;me.zone=newZone;spacer.order=newIndexOneBased;spacer.zone=newZone;z[newIndexOneBased]=spacer;z[newIndexOneBased+1]=me;if(null==lastWidget||null==wgt||lastWidget.elementid!=wgt.elementid){var diff=0;if(newZone==oldZone){diff=2;}
self.zones[oldZone][oldOrder+diff]=undefined;self.zones[oldZone][oldOrder-1+diff]=undefined;}}
mljs.defaultconnection.logger.debug("layout<subclass>.moveToPosition: Moving (decrementing order) widgets passed original position");z=self.zones[oldZone];for(var w=1,maxw=z.length,wtm;w<maxw;w++){wtm=z[w];if(undefined!=wtm){if(wtm.zone!=oldZone){z[w]=undefined;}else{if(wtm.order!=w){z[w]=undefined;}}}}
self._eliminateBlanks(z);self._eliminateBlanks(z);mljs.defaultconnection.logger.debug("layout<subclass>.moveToPosition: Moving HTML element");self._moveElementToPosition(me,spacer,wgt);mljs.defaultconnection.logger.debug("layout<subclass>.moveToPosition: Ended");};self._eliminateBlanks=function(z){var foundGap=0;var maxOrder=0;for(var w=1,max=z.length,moveme;w<max;w++){moveme=z[w];if(undefined==moveme){foundGap++;for(var nw=w+1,maxnw=max,newitem;nw<maxnw;nw++){z[nw-1]=z[nw];if(undefined!=z[nw-1]){z[nw-1].order=nw-1;}
z[nw]=undefined;}
max--;}else{}}
maxOrder=max;for(var w=maxOrder+1,max=z.length,moveme;w<max;w++){z[w]=undefined;}};self._moveElementToPosition=function(me,spacer,wgt){mljs.defaultconnection.logger.debug("layout<subclass>._moveElementToPosition: Entered");if(undefined!=self._moveElementToPositionOverride){mljs.defaultconnection.logger.debug("layout<subclass>._moveElementToPosition: Caling override");self._moveElementToPositionOverride(me,spacer,wgt);}else{mljs.defaultconnection.logger.debug("layout<subclass>._moveElementToPosition: Moving element position");var movingel=document.getElementById(me.elementid);var currentel=document.getElementById(wgt.elementid);mljs.defaultconnection.logger.debug("layout<subclass>._moveElementToPosition: movingelid: "+me.elementid+", currentelid: "+wgt.elementid);currentel.parentNode.insertBefore(movingel,currentel);if(null!=spacer){mljs.defaultconnection.logger.debug("layout<subclass>._moveElementToPosition: Moving spacer with html elid: "+spacer.elementid);var spacerel=document.getElementById(spacer.elementid);currentel.parentNode.insertBefore(spacerel,movingel);}}
mljs.defaultconnection.logger.debug("layout<subclass>._moveElementToPosition: Ended");};};com.marklogic.widgets.layouts.thinthick=function(container){com.marklogic.widgets.layouts.helper.extendLayout(this,container,["A","B"]);this._init();};com.marklogic.widgets.layouts.thinthick.prototype._init=function(){var s="<div id='"+this.container+"-layout' class='container_12 row mljswidget layout thinthick'>";s+="<div id='"+this.container+"-A' class='grid_4 col-md-4 col-xs-12 thinthick-thin'></div>";s+="<div id='"+this.container+"-B' class='grid_8 col-md-8 col-xs-12 thinthick-thick'></div>";s+="</div>";var el=document.getElementById(this.container);if(undefined==el){console.log("WARNING: ATTEMPTING TO SET NON EXISTENT LAYOUT ELEMENT: "+this.container);}else{el.innerHTML=s;}};com.marklogic.widgets.layouts.thickthin=function(container){com.marklogic.widgets.layouts.helper.extendLayout(this,container,["A","B"]);this._init();};com.marklogic.widgets.layouts.thickthin.prototype._init=function(){var s="<div id='"+this.container+"-layout' class='container_12 row mljswidget layout thickthin'>";s+="<div id='"+this.container+"-A' class='grid_8 col-md-8 col-xs-12 thickthin-thick'></div>";s+="<div id='"+this.container+"-B' class='grid_4 col-md-4 col-xs-12 thickthin-thin'></div>";s+="</div>";var el=document.getElementById(this.container);if(undefined==el){console.log("WARNING: ATTEMPTING TO SET NON EXISTENT LAYOUT ELEMENT: "+this.container);}else{el.innerHTML=s;}};com.marklogic.widgets.layouts.column=function(container){com.marklogic.widgets.layouts.helper.extendLayout(this,container,["A"]);this._init();};com.marklogic.widgets.layouts.column.prototype._init=function(){var s="<div id='"+this.container+"-layout' class='container_12 row mljswidget layout column'>";s+="<div id='"+this.container+"-A' class='column col-md-12 col-xs-12'></div>";s+="</div>";var el=document.getElementById(this.container);if(undefined==el){console.log("WARNING: ATTEMPTING TO SET NON EXISTENT LAYOUT ELEMENT: "+this.container);}else{el.innerHTML=s;}};com.marklogic.widgets.layouts.twocolumns=function(container){com.marklogic.widgets.layouts.helper.extendLayout(this,container,["A","B"]);this._init();};com.marklogic.widgets.layouts.twocolumns.prototype._init=function(){var s="<div id='"+this.container+"-layout' class='container_12 row mljswidget layout twocolumns'>";s+="<div id='"+this.container+"-A' class='grid_6 col-md-6 col-xs-12 twocolumns-left'></div>";s+="<div id='"+this.container+"-B' class='grid_6 col-md-6 col-xs-12 twocolumns-right'></div>";s+="</div>";var el=document.getElementById(this.container);if(undefined==el){console.log("WARNING: ATTEMPTING TO SET NON EXISTENT LAYOUT ELEMENT: "+this.container);}else{el.innerHTML=s;}};com.marklogic.widgets.layouts.threecolumns=function(container){com.marklogic.widgets.layouts.helper.extendLayout(this,container,["A","B"]);this._init();};com.marklogic.widgets.layouts.threecolumns.prototype._init=function(){var s="<div id='"+this.container+"-layout' class='container_12 row mljswidget layout threecolumns'>";s+="<div id='"+this.container+"-A' class='grid_4 col-md-4 col-xs-12 threecolumns-left'></div>";s+="<div id='"+this.container+"-B' class='grid_4 col-md-4 col-xs-12 threecolumns-center'></div>";s+="<div id='"+this.container+"-C' class='grid_4 col-md-4 col-xs-12 threecolumns-right'></div>";s+="</div>";var el=document.getElementById(this.container);if(undefined==el){console.log("WARNING: ATTEMPTING TO SET NON EXISTENT LAYOUT ELEMENT: "+this.container);}else{el.innerHTML=s;}};com.marklogic.widgets.layouts.thinthickthin=function(container){com.marklogic.widgets.layouts.helper.extendLayout(this,container,["A","B"]);this._init();};com.marklogic.widgets.layouts.thinthickthin.prototype._init=function(){var s="<div id='"+this.container+"-layout' class='container_12 row mljswidget layout thinthickthin'>";s+="<div id='"+this.container+"-A' class='grid_3 col-md-3 col-xs-12 thinthickthin-left'></div>";s+="<div id='"+this.container+"-B' class='grid_6 col-md-6 col-xs-12 thinthickthin-center'></div>";s+="<div id='"+this.container+"-C' class='grid_3 col-md-3 col-xs-12 thinthickthin-right'></div>";s+="</div>";var el=document.getElementById(this.container);if(undefined==el){console.log("WARNING: ATTEMPTING TO SET NON EXISTENT LAYOUT ELEMENT: "+this.container);}else{el.innerHTML=s;}};com.marklogic.widgets.actions={};com.marklogic.widgets.actions.javascript=function(){this._config={target:null,method:null,parameters:[]};};com.marklogic.widgets.actions.javascript.getConfigurationDefinition=function(){};com.marklogic.widgets.actions.javascript.prototype.setConfiguration=function(config){for(var prop in config){this._config[prop]=config[prop];}};com.marklogic.widgets.actions.javascript.prototype.execute=function(executionContext){if((null==this._config.target)||(null==this._config.method)){return{executed:false,details:"targetObject or methodName are null"};}
var obj=executionContext.getInstance(this._config.target);mljs.defaultconnection.logger.debug("Got target object?: "+obj);mljs.defaultconnection.logger.debug("Fetching method name: "+this._config.method);var func=(obj[this._config.method]);mljs.defaultconnection.logger.debug("Got target object function: "+func);var params=[];for(var p=0,maxp=this._config.parameters.length,par;p<maxp;p++){par=this._config.parameters[p];var parValue=null;if("string"==par.type){parValue=par.value;}else if("number"==par.type){parValue=1*par.value;}else if("null"==par.type){parValue=null;}else if("queryStringParameter"==par.type){var ins=com.marklogic.widgets.pagecontext.instance;if(undefined!=ins){parValue=ins.getParameter(par.value);}}
params.push(parValue);}
var result=func.apply(obj,params);return{executed:true,result:result,details:"Method executed successfully"};};com.marklogic.widgets.workplacecontext=function(){this._json={shared:false,widgets:[],assignments:[],contexts:[],actions:{onload:[],onunload:[]},layout:"thinthick",title:"New Workplace",urls:[]};this._lastSaved=this._json;this._uri=null;this.db=mljs.defaultconnection;this._cachedPages=new Array();this._cached=false;this._instanceNames={};this._linker=new com.marklogic.events.Linker();this.updatePublisher=new com.marklogic.events.Publisher();this._myPagesPublisher=new com.marklogic.events.Publisher();this._objectTypeMap={};this._actions=[{targetClass:"SearchContext",methodName:"doSimpleQuery",parameters:[{title:"query",type:"string",default:"",description:"The query string for the current grammar."}]},{targetClass:"SearchContext",methodName:"doStructuredQuery",parameters:[{title:"structuredQuery",type:"string",default:{"and-query":[]},description:"The structured query JSON."}]},{targetClass:"com.marklogic.widgets.graphexplorer",methodName:"drawSubject",parameters:[{title:"subjectIri",type:"string",default:"",description:"The IRI of the subject to render."}]},{targetClass:"SemanticContext",methodName:"subjectQuery",parameters:[{title:"sparql",type:"string",default:"SELECT ?s WHERE {}",description:"The SPARQL that returns a ?subject value."},{title:"offset",type:"integer",default:0,description:"Which result to start at (for multi page results)."},{title:"limit",type:"integer",default:10,description:"The number to return per page of results."}]},{targetClass:"SemanticContext",methodName:"subjectFacts",parameters:[{title:"iri",type:"string",default:"",description:"The IRI of the subject to fetch facts for."}]},{targetClass:"SemanticContext",methodName:"queryFacts",parameters:[{title:"sparql",type:"string",default:"SELECT ?s ?p ?o WHERE {}",description:"The SPARQL which returns the list of facts of interest."}]},{targetClass:"GeoContext",methodName:"go",parameters:[{title:"lon",type:"decimal",minimum:-180,maximum:+180,default:"0",description:"The Longitude (East-West) of the point of interest in WGS84/EPSG4326 format."},{title:"lat",type:"decimal",minimum:-90,maximum:+90,default:"52",description:"The Latitude (North-South) of the point of interest in WGS84/EPSG4326 format."},{title:"zoom",type:"positiveInteger",minimum:1,maximum:15,default:"13",description:"Zoom level to use (13 is urban area)."}]},{targetClass:"DocumentContext",methodName:"getContent",parameters:[{title:"docuri",type:"string",default:"",description:"The MarkLogic document URI to fetch content for."}]},{targetClass:"DocumentContext",methodName:"getProperties",parameters:[{title:"docuri",type:"string",default:"",description:"The MarkLogic document URI to fetch properties for."}]},{targetClass:"DocumentContext",methodName:"getFacets",parameters:[{title:"docuri",type:"string",default:"",description:"The MarkLogic document URI to fetch facets for."},{title:"optionsName",type:"string",default:"all",description:"The MarkLogic search options that specify the facets to load."},]}];};com.marklogic.widgets.workplacecontext.prototype.getContextClass=function(type){var wobj=com;var splits=type.split(".");if(1==splits.length){wobj=mljs.defaultconnection[splits[0].toLowerCase()];}else{for(var i=1,max=splits.length,split;i<max;i++){split=splits[i];wobj=wobj[split];}}
return wobj;};com.marklogic.widgets.workplacecontext.prototype.getContextInstance=function(type){var cls=this.getContextClass(type);var inst=new cls();mljs.defaultconnection.linkContext(inst);return inst;};com.marklogic.widgets.workplacecontext.prototype.getInstancesOf=function(cname){var instances=new Array();for(var i=0,maxi=this._json.widgets.length,wgt;i<maxi;i++){wgt=this._json.widgets[i];if(wgt.type==cname){instances.push(wgt.widget);}}
for(var i=0,maxi=this._json.contexts.length,wgt;i<maxi;i++){wgt=this._json.contexts[i];if(wgt.type==cname){instances.push(wgt.context);}}
return instances;};com.marklogic.widgets.workplacecontext.prototype.getInstances=function(){var instances=new Array();for(var i=0,maxi=this._json.widgets.length,wgt;i<maxi;i++){wgt=this._json.widgets[i];instances.push(wgt.widget);}
for(var i=0,maxi=this._json.contexts.length,wgt;i<maxi;i++){wgt=this._json.contexts[i];instances.push(wgt.context);}
return instances;};com.marklogic.widgets.workplacecontext.prototype.setActionDescriptions=function(descs){this._actions=descs;};com.marklogic.widgets.workplacecontext.prototype.getActionDescription=function(targetClass,methodName){for(var a=0,maxa=this._actions.length,config;a<maxa;a++){config=this._actions[a];if(config.targetClass==targetClass&&config.methodName==methodName){return config;}}
return null;};com.marklogic.widgets.workplacecontext.prototype.setActionList=function(listName,actionArray){if(undefined==this._json.actions||Array.isArray(this._json.actions)){this._json.actions={};}
this._json.actions[listName]=actionArray;};com.marklogic.widgets.workplacecontext.prototype.getActionDescriptions=function(){return this._actions;};com.marklogic.widgets.workplacecontext.prototype.getObjectType=function(objectName){return this._objectTypeMap[objectName];};com.marklogic.widgets.workplacecontext.prototype.getObjectTypes=function(){return this._objectTypeMap;};com.marklogic.widgets.workplacecontext.prototype._calculateObjectTypeMap=function(){var json=this._json;this._objectTypeMap={};for(var i=0,maxi=json.widgets.length,wgt;i<maxi;i++){wgt=json.widgets[i];this._objectTypeMap[wgt.widget]=wgt.type;}
i=0;maxi=json.contexts.length;for(var ctx;i<maxi;i++){ctx=json.contexts[i];this._objectTypeMap[ctx.context]=ctx.type;}
bubbleSort(this._objectTypeMap,"name");};com.marklogic.widgets.workplacecontext.prototype.loadMyPages=function(){var self=this;var ob=this.db.createOptions();ob.collectionConstraint().returnFacets(false).returnResults(true).pageLength(1000).raw();var qb=this.db.createQuery();qb.query(qb.collection("/config/workplace/page"));var sc=this.db.createSearchContext();sc.setOptions("mljsMyWorkplacePages",ob);sc.addResultsListener(function(results){if(true===results||false===results){return;}
var pages=new Array();for(var i=0,maxi=results.results.length,page;i<maxi;i++){page=results.results[i].content;pages.push({uri:results.results[i].uri,page:page});}
self._cachedPages=pages;self._myPagesPublisher.publish(pages);});sc.doStructuredQuery(qb.toJson());};com.marklogic.widgets.workplacecontext.prototype.getCachedPages=function(){if(false===this._cachedPages){this.loadMyPages();}
return this._cachedPages;};com.marklogic.widgets.workplacecontext.prototype.createPage=function(pageJson){var self=this;this.db.save(pageJson,"/admin/workplace/"+this.__genid()+".json",{collection:"/config/workplace/page"},function(result){if(result.inError){}else{self._cachedPages.push({uri:result.docuri,page:pageJson});self._myPagesPublisher.publish(self._cachedPages);}});};com.marklogic.widgets.workplacecontext.prototype.__genid=function(){return""+((new Date()).getTime())+"-"+Math.ceil(Math.random()*100000000);};com.marklogic.widgets.workplacecontext.prototype.deletePage=function(uri){var self=this;this.db.delete(uri,function(result){if(result.inError){}else{var newcache=new Array();for(var p=0,maxp=self._cachedPages.length,page;p<maxp;p++){page=self._cachedPages[p];if(uri!=page.uri){newcache.push(page);}}
self._cachedPages=newcache;self._myPagesPublisher.publish(self._cachedPages);}});};com.marklogic.widgets.workplacecontext.prototype.resetWidgetConfig=function(){this._json.widgets=[];this._json.assignments=[];};com.marklogic.widgets.workplacecontext.prototype.nextWidgetName=function(classname){var classString=classname.split(".").pop().toLowerCase();var next=this._instanceNames[classString];if(undefined==next){next=1;this._instanceNames[classString]=2;}
return classString+next;};com.marklogic.widgets.workplacecontext.prototype._addWidgetName=function(shortname){var matches=shortname.match(/\d+$/);if(matches){var number=matches[0];var endPos=shortname.indexOf(number);var classString=shortname.substring(0,endPos);number=parseInt(number,10);var next=this._instanceNames[classString];if(undefined==next){next=0;}
if(next<=number){this._instanceNames[classString]=number+1;}}else{throw new TypeError("shortname: "+shortname+" not a valid widget short name - no number at end of name.");}};com.marklogic.widgets.workplacecontext.prototype.revert=function(){this._json=this._lastSaved;this._calculateObjectTypeMap();};com.marklogic.widgets.workplacecontext.prototype.setWorkplaceUri=function(uri){this._uri=uri;};com.marklogic.widgets.workplacecontext.prototype.save=function(callback){var self=this;this.saveWorkplace(this._json,this._uri,null,function(result){console.log("WORKPLACE SAVED");self.loadPageWithUri(self._uri);callback();self.loadMyPages();});};com.marklogic.widgets.workplacecontext.prototype.getWorkplace=function(name,callback){if(undefined==name){callback(this._json);}
if(-1==name.indexOf(".json")){this.db.get("/admin/workplace/"+encodeURI(name)+".json",callback);}else{this.db.get(name,callback);}};com.marklogic.widgets.workplacecontext.prototype.saveWorkplace=function(json,uri_opt,props_opt,callback){var col=null;if(undefined!=props_opt){col=props_opt.collection;}
var wpcols="mljsInternalData,mljsWorkplacePages,/config/workplace/page";if(undefined==col){col=wpcols;}else{col=col+","+wpcols;}
if(undefined==props_opt){props_opt={};}
props_opt.collection=col;this.db.save(json,uri_opt||"/admin/workplace/"+this.__genid()+".json",props_opt,callback);};com.marklogic.widgets.workplacecontext.prototype.loadWorkplace=function(uri){var self=this;this.db.get(uri,function(result){if(result.inError){}else{self._uri=uri;self._json=result.doc;self._lastSaved=self._json;self._processConfig();self._fireUpdate();}});};com.marklogic.widgets.workplacecontext.prototype.findWorkplace=function(pageurl,callback){var ob=this.db.createOptions();ob.valueConstraint("item","item",ob.JSON).jsonContainerConstraint("urls","urls").returnFacets(false).returnResults(true).raw();var qb=this.db.createQuery();qb.query(qb.container("urls",qb.value("item",pageurl)));var sc=this.db.createSearchContext();sc.setOptions("mljsFindWorkplace",ob);sc.addResultsListener(function(results){if(true===results||false===results){return;}
callback({inError:false,doc:results.results[0]});});sc.doStructuredQuery(qb.toJson());};com.marklogic.widgets.workplacecontext.prototype.listSharedWorkplaces=function(callback){};com.marklogic.widgets.workplacecontext.prototype.getJson=function(){return this._json;};com.marklogic.widgets.workplacecontext.prototype.getSummary=function(){return{title:this._json.title,urls:this._json.urls,layout:this._json.layout,shared:this._json.shared};};com.marklogic.widgets.workplacecontext.prototype.setSummary=function(title,urls,layout,shared){this._json.title=title;this._json.urls=urls;this._json.layout=layout;this._json.shared=shared;};com.marklogic.widgets.workplacecontext.prototype.setLayout=function(newLayout){this._json.layout=newLayout;};com.marklogic.widgets.workplacecontext.prototype.setUrls=function(urlArray){this._json.urls=urlArray;};com.marklogic.widgets.workplacecontext.prototype.getWidgets=function(){return this._json.widgets;};com.marklogic.widgets.workplacecontext.prototype.addWidget=function(name,type,config){var wgt={widget:name,type:type,config:config};this._addWidgetName(name);this._json.widgets.push(wgt);return wgt;};com.marklogic.widgets.workplacecontext.prototype.removeWidget=function(name){var wgts=[];for(var i=0;i<this._json.widgets.length;i++){if(this._json.widgets[i].name==name){}else{wgts.push(this._json.widgets[i]);}}
this._json.widgets=wgts;};com.marklogic.widgets.workplacecontext.prototype.getAssignments=function(){return this._json.assignments;};com.marklogic.widgets.workplacecontext.prototype.setAssignments=function(assignments){this._json.assignments=assignments;};com.marklogic.widgets.workplacecontext.prototype.placeWidget=function(name,zone,order){var zoneWidgets=[];var otherWidgets=[];var maxo=0;for(var i=0,w,max=this._json.assignments.length;i<max;i++){w=this._json.assignments[i];if(w.zone==zone){zoneWidgets[w.order-1]=w;maxo=w.order;}else{otherWidgets.push(w);}}
for(var i=maxo-1;i>order-1;i--){zoneWidgets[maxo]=zoneWidgets[maxo-1];zoneWidgets[maxo].order++;zoneWidgets[maxo-1]=undefined;}
zoneWidgets[order-1]={widget:name,zone:zone,order:order};var places=[];for(var i=0;i<otherWidgets.length;i++){places.push(otherWidgets[i]);}
for(var i=0;i<zoneWidgets.length;i++){places.push(zoneWidgets[i]);}
this._json.assignments=places;};com.marklogic.widgets.workplacecontext.prototype.getContexts=function(){return this._json.contexts;};com.marklogic.widgets.workplacecontext.prototype.addContext=function(name,type,config){this._json.contexts.push({context:name,type:type,config:config,register:[]});};com.marklogic.widgets.workplacecontext.prototype.removeContext=function(context){var pos=-1;for(var c=0,maxc=this._json.contexts.length,ctx;c<maxc&&(-1==pos);c++){ctx=this._json.contexts[c];if(ctx.context==context){pos=c;}}
if(-1!=pos){this._json.contexts.splice(pos,1);}};com.marklogic.widgets.workplacecontext.prototype.registerWidget=function(widgetName,contextName){for(var i=0,max=this._json.contexts.length,c;i<max;i++){c=this._json.contexts[i];if(c.context==contextName){if(!c.register.contains(widgetName)){c.register.push(widgetName);}
return;}}};com.marklogic.widgets.workplacecontext.prototype.setWidgetConfig=function(widgetName,config){for(var i=0,max=this._json.widgets.length,w;i<max;i++){w=this._json.widgets[i];if(w.widget==widgetName){w.config=config;return;}}};com.marklogic.widgets.workplacecontext.prototype.getWidgetInfo=function(widgetName){mljs.defaultconnection.logger.debug("workplacecontext.getWidgetInfo: Finding config for: "+widgetName);for(var i=0,max=this._json.widgets.length,w;i<max;i++){mljs.defaultconnection.logger.debug("workplacecontext.getWidgetInfo: Checking widget with pos: "+i);w=this._json.widgets[i];mljs.defaultconnection.logger.debug("workplacecontext.getWidgetInfo: widget: "+JSON.stringify(w));if(w.widget==widgetName){mljs.defaultconnection.logger.debug("workplacecontext.getWidgetInfo: Match!");return w;}}
return null;};com.marklogic.widgets.workplacecontext.prototype.getActions=function(){return this._json.actions;};com.marklogic.widgets.workplacecontext.prototype.addOnloadAction=function(type,config){this._json.actions.onload.push({type:type,config:config});};com.marklogic.widgets.workplacecontext.prototype.addOnUnloadAction=function(type,config){this._json.actions.onunload.push({type:type,config:config});};com.marklogic.widgets.workplacecontext.prototype.addContextAction=function(contextName,event,actiontype,actionconfig){};com.marklogic.widgets.workplacecontext.prototype._processConfig=function(){if(undefined==this._json.widgets){this._json.widgets=[];}
for(var i=0,max=this._json.widgets.length,wgt;i<max;i++){wgt=this._json.widgets[i];this._addWidgetName(wgt.widget);}
if(undefined==this._json.contexts){this._json.contexts=[];}
for(var i=0,max=this._json.contexts.length,ctx;i<max;i++){ctx=this._json.contexts[i];this._addWidgetName(ctx.context);}
if(undefined==this._json.actions){this._json.actions={onload:[],onunload:[]};}
if(undefined==this._json.assignments){this._json.assignments=[];}
if(undefined==this._json.layout){this._json.layout="thinthick";}
if(undefined==this._json.urls){this._json.urls=[];}
this._calculateObjectTypeMap();};com.marklogic.widgets.workplacecontext.prototype.loadPage=function(jsonOrString,json_opt){mljs.defaultconnection.logger.debug("workplacecontext.loadPage: value: "+jsonOrString);if(typeof(jsonOrString)=="string"){mljs.defaultconnection.logger.debug("workplacecontext.loadPage: Got server URI workplace page definition");var self=this;this.findWorkplace(jsonOrString,function(result){if(result.inError&&undefined!=json_opt){mljs.defaultconnection.logger.debug("workplacecontext.loadPage: findWorkplace call resulted in error: "+result.detail);self._uri=null;self._json=json_opt;}else{if(undefined!=result.doc){mljs.defaultconnection.logger.debug("workplacecontext.loadPage: Found workplace with uri: "+result.doc.uri);self._uri=result.doc.uri;self._json=result.doc.content;}else{mljs.defaultconnection.logger.debug("workplacecontext.loadPage: findWorkplace worked, but with no result");self._uri=null;self._json=json_opt;}}
if(undefined!=self._json){mljs.defaultconnection.logger.debug("workplacecontext.loadPage: Processing page JSON");if("string"==typeof(self._json)){self._json=JSON.parse(self._json);}
self._lastSaved=self._json;self._processConfig();self._fireUpdate();}});}else{mljs.defaultconnection.logger.debug("workplacecontext.loadPage: Got JSON string workplace page definition");this._json=jsonOrString;this._lastSaved=this._json;this._processConfig();this._fireUpdate();}};com.marklogic.widgets.workplacecontext.prototype.loadPageWithUri=function(uri){this._uri=uri;var self=this;this.getWorkplace(uri,function(result){self._json=result.doc;self._lastSaved=self._json;self._processConfig();self._fireUpdate();});};com.marklogic.widgets.workplacecontext.prototype.register=function(widget){if(undefined!=widget.setWorkplaceContext){widget.setWorkplaceContext(this);}
if(undefined!=widget.updateWorkplace){var func=function(wp){widget.updateWorkplace(wp);};this.addWorkplaceUpdateListener(func);this._linker.link(widget,"WorkplaceUpdateListener",func);}
if(undefined!=widget.updateMyPages){var func=function(pages){widget.updateMyPages(pages);};this._myPagesPublisher.subscribe(func);this._linker.link(widget,"myPagesPublisher",func);}};com.marklogic.widgets.workplacecontext.prototype.unregister=function(widget){if(undefined!=widget.updateWorkplace){var func=this._linker.find(widget,"WorkplaceUpdateListener");this.removeWorkplaceUpdateListener(func);}
if(undefined!=widget.updateMyPages){var func=this._linker.find(widget,"myPagesPublisher");this._myPagesPublisher.unsubscribe(func);}};com.marklogic.widgets.workplacecontext.prototype._fireUpdate=function(){this.updatePublisher.publish(this);};com.marklogic.widgets.workplacecontext.prototype.addWorkplaceUpdateListener=function(lis){this.updatePublisher.subscribe(lis);};com.marklogic.widgets.workplacecontext.prototype.removeWorkplaceUpdateListener=function(lis){this.updatePublisher.unsubscribe(lis);};com.marklogic.widgets.workplaceadmin=function(container){this.container=container;this._workplaceContext=new com.marklogic.widgets.workplacecontext();this._config={widgetList:[{title:"Address Bar",classname:"com.marklogic.widgets.addressbar",description:"Update geocontext home by looking up text address."},{title:"Co-occurence",classname:"com.marklogic.widgets.cooccurence",description:"Shows two way co-occurence between elements in a document."},{title:"Create Document",classname:"com.marklogic.widgets.create",description:"Form builder used to generate a new document on submission."},{title:"Document Properties",classname:"com.marklogic.widgets.docproperties",description:"Shows the MarkLogic Properties of a Document."},{title:"XHTML Head Viewer",classname:"com.marklogic.widgets.docheadviewer",description:"Shows the Meta data elements within an XHTML document."},{title:"XHTML Content Viewer",classname:"com.marklogic.widgets.docviewer",description:"Displays XHTML content inline within a page."},{title:"Graph Explorer",classname:"com.marklogic.widgets.graphexplorer",description:"HighCharts powered node diagram to explore semantic subjects and related document facets."},{title:"HighCharts",classname:"com.marklogic.widgets.highcharts",description:"HighCharts powered charting."},{title:"Google Kratu",classname:"com.marklogic.widgets.kratu",description:"Google Kratu tabular display of content and semantic search results."},{title:"OpenLayers Map",classname:"com.marklogic.widgets.openlayers",description:"OpenLayers powered map supporting multiple layer types and geospatial search"},{title:"Search Bar",classname:"com.marklogic.widgets.searchbar",description:"Content search query box supporting the default grammar."},{title:"Search Sorter",classname:"com.marklogic.widgets.searchsort",description:"Sort search results based on existing sorting options."},{title:"Search Pager",classname:"com.marklogic.widgets.searchpager",description:"Page through search results."},{title:"Search Facets",classname:"com.marklogic.widgets.searchfacets",description:"Show facets returned from a search, and allow their selection."},{title:"Search Results",classname:"com.marklogic.widgets.searchresults",description:"Show search results. Supports built in and custom rendering."},{title:"Search Results Selection",classname:"com.marklogic.widgets.selection",description:"List documents selected in Search Results."},{title:"Refresh Search",classname:"com.marklogic.widgets.refreshsearch",description:"Refresh button for a search on this page."},{title:"Structured Search Selection",classname:"com.marklogic.widgets.searchselection",description:"Select a structured search to execute."},{title:"Semantic Search Bar",classname:"com.marklogic.widgets.sparqlbar",description:"Visually create a sophisticated SPARQL query."},{title:"Semantic Search Results",classname:"com.marklogic.widgets.sparqlresults",description:"Show a summary of Subjects returned from a SPARQL query."},{title:"Semantic Subject Facts",classname:"com.marklogic.widgets.entityfacts",description:"Show the list of facts about a specific subject."},{title:"Tag Cloud",classname:"com.marklogic.widgets.tagcloud",description:"Show facet values as text, varying their font size by frequency."}],layoutList:[{title:"Thin Thick",classname:"com.marklogic.widgets.layouts.thinthick",description:"Sidebar column on left of main column"},{title:"Thick Thin",classname:"com.marklogic.widgets.layouts.thickthin",description:"Sidebar column on right of main column"},{title:"Column",classname:"com.marklogic.widgets.layouts.column",description:"Single column, content widgets are horizontal panels"},{title:"Two Columns",classname:"com.marklogic.widgets.layouts.twocolumns",description:"Two columns, equal widths"},{title:"Three columns",classname:"com.marklogic.widgets.layouts.threecolumns",description:"Three columns, equal widths"},{title:"Thin Thick Thin",classname:"com.marklogic.widgets.layouts.thinthickthin",description:"Three columns, center column wider"}],contextList:[{title:"Search Context",shortname:"SearchContext",classname:null,description:"Content Search Context"},{title:"Semantic Context",shortname:"SemanticContext",classname:null,description:"Semantic Search Context"},{title:"Document Context",shortname:"DocumentContext",classname:null,description:"Individual Document properties and content Context"},{title:"Geo Context",shortname:"GeoContext",classname:null,description:"Geospatial position Context"},{title:"Alert Context",shortname:"AlertContext",classname:null,description:"Alert configuration and receiving Context"},{title:"Data Context",shortname:"DataContext",classname:null,description:"Data joining and processing context"}]};var exts=com.marklogic.widgets.workplaceadminext;if(undefined!=exts){var widgets=exts.widgets;if(undefined!=widgets){for(var module in widgets){var mod=widgets[module];if(Array.isArray(mod)){for(var w=0,maxw=mod.length,wgt;w<maxw;w++){wgt=mod[w];this._config.widgetList.push(wgt);}}}}
var layouts=exts.layouts;if(undefined!=layouts){for(var module in layouts){var mod=layouts[module];if(Array.isArray(mod)){for(var w=0,maxw=mod.length,layout;w<maxw;w++){layout=mod[w];this._config.layoutList.push(layout);}}}}
var contexts=exts.contexts;if(undefined!=contexts){for(var module in contexts){var mod=contexts[module];if(Array.isArray(mod)){for(var w=0,maxw=mod.length,context;w<maxw;w++){context=mod[w];this._config.contextList.push(context);}}}}}
this.closePublisher=new com.marklogic.events.Publisher();this._currentTab="page";this._nextID=1;this._configWrappers=new Array();this._refresh();};com.marklogic.widgets.workplaceadmin.prototype.addSupportedWidgets=function(widgetDefArray){for(var i=0,max=widgetDefArray.length,def;i<max;i++){def=widgetDefArray[i];this._config.widgetList.push(def);}};com.marklogic.widgets.workplaceadmin.prototype.addSupportedLayouts=function(layoutDefArray){for(var i=0,max=layoutDefArray.length,def;i<max;i++){def=layoutDefArray[i];this._config.layoutList.push(def);}};com.marklogic.widgets.workplaceadmin.prototype.getWidgetSummary=function(widgetclass){for(var i=0,max=this._config.widgetList.length,wc;i<max;i++){wc=this._config.widgetList[i];if(wc.classname==widgetclass){return wc;}}
return null;};com.marklogic.widgets.workplaceadmin.renderFullscreen=function(workplacecontext){var el=document.createElement("div");el.id="workplaceeditormain";document.body.appendChild(el);var admin=new com.marklogic.widgets.workplaceadmin("workplaceeditormain");workplacecontext.register(admin);admin.updateWorkplace(workplacecontext);admin.addCloseListener(function(wgt){document.body.removeChild(document.getElementById("workplaceeditormain"));});};com.marklogic.widgets.workplaceadmin.prototype.addCloseListener=function(lis){this.closePublisher.subscribe(lis);};com.marklogic.widgets.workplaceadmin.prototype.removeCloseListener=function(lis){this.closePublisher.unsubscribe(lis);};com.marklogic.widgets.workplaceadmin.prototype.setWorkplaceContext=function(ctx){mljs.defaultconnection.logger.debug("workplaceadmin.setWorkplaceContext: called.");this._workplaceContext=ctx;};com.marklogic.widgets.workplaceadmin.prototype.getWorkplaceContext=function(){return this._workplaceContext;};com.marklogic.widgets.workplaceadmin.prototype._refresh=function(){var str="<div id='"+this.container+"-workplaceadmin' class='mljswidget panel panel-default workplaceadmin'>";str+="  <div class='panel-body'>";str+="   <div id='"+this.container+"-panels' class='workplaceadmin-panels'>";str+="    <div class='well'>";str+="<div class='page-header workplaceadmin-panels-heading-outer'>";str+="  Edit Workplace Page";str+="</div>";str+="<div class='panel panel-primary' id='"+this.container+"-page-outer'>";str+="  <div id='"+this.container+"-page-heading' class='panel-heading workplaceadmin-page-heading'>";str+="   Page Settings";str+="</div>";str+="  <div id='"+this.container+"-page-content' class='panel-body workplaceadmin-page-content'>";str+=" <div class='form-group'>";str+="  <label>Page Title</label>";str+="  <input type='text' id='"+this.container+"-page-title' class='form-control' placeholder='Title' />";str+=" </div>";str+=" <div class='form-group'>";str+="  <label>URL(s)</label>";str+="  <textarea class='form-control' placeholder='Title' id='"+this.container+"-page-urls'></textarea>";str+=" </div>";str+=" <div class='form-group'>";str+="  <label>Main Layout</label>";str+=" <select id='"+this.container+"-page-layout' class='form-control'>";for(var i=0,l,max=this._config.layoutList.length;i<max;i++){l=this._config.layoutList[i];var splits=l.classname.split(".");var shortname=splits[splits.length-1];str+="  <option value='"+shortname+"' title='"+l.description+"' id='"+this.container+"-layoutselect-"+shortname+"'>"+l.title+"</option>";}
str+=" </select>";str+=" </div>";str+="  </div>";str+="</div>";str+="<div class='panel panel-info' id='"+this.container+"-widgets-outer'>";str+="  <div id='"+this.container+"-widgets-heading' class='panel-heading workplaceadmin-widgets-heading'>Widgets</div>";str+="  <div id='"+this.container+"-widgets-content' class='panel-body workplaceadmin-widgets-content hidden'>";str+="<table class='mljstable workplaceadmin-widgets-list'>"
for(var i=0,col=0,max=this._config.widgetList.length,w;i<max;i++){w=this._config.widgetList[i];col=i%3;if(0==col){str+="<tr>";}
str+="<td id='"+this.container+"-widgets-"+i+"' title='"+w.title+"'>";str+="<div class='workplaceadmin-widgets-list-img' id='"+this.container+"-widgets-"+i+"-img'"
if(undefined!=w.icon&&""!=w.icon){str+=" style='background-image: url("+w.icon+");'";}
str+=" draggable='true'><div class='workplaceadmin-widgets-list-span'>"+w.title+"</div></div>";str+="</td>";if(2==col){str+="</tr>";}}
if(col<2&&i>0){str+="</tr>";}
str+="</table>";str+="  </div>";str+="</div>";str+="<div class='panel panel-info' id='"+this.container+"-contexts-outer'>";str+="  <div id='"+this.container+"-contexts-heading' class='panel-heading workplaceadmin-contexts-heading'>Contexts</div>";str+="  <div id='"+this.container+"-contexts-content' class='panel-body workplaceadmin-contexts-content hidden'>";str+="   <div id='"+this.container+"-contexts-list' class='workplaceadmin-contexts-list'><i>None</i></div>";str+="   <div id='"+this.container+"-contexts-add' class='workplaceadmin-contexts-add'>";str+="<div role='form' class='form-inline' >";str+=" <div class='form-group'>";str+="<select id='"+this.container+"-contexts-add-dropdown' class='form-control workplaceadmin-contexts-add-dropdown'>";for(var i=0,maxi=this._config.contextList.length,ctx;i<maxi;i++){ctx=this._config.contextList[i];str+="<option value='"+(ctx.classname||ctx.shortname)+"' title='"+ctx.title+"' id='"+
this.container+"-contextselect-"+(ctx.classname||ctx.shortname)+"'>"+ctx.title+"</option>";}
str+="</select>";str+="</div>";str+="<button class='btn btn-default' id='"+this.container+"-contexts-add-button'>";str+="<span class='glyphicon glyphicon-plus workplaceadmin-contexts-addcontext btn-fix'></span>";str+="</button>";str+="</div>";str+="   </div>";str+="  </div>";str+="</div>";str+="<div class='panel panel-info' id='"+this.container+"-actions-outer'>";str+="  <div id='"+this.container+"-actions-heading' class='panel-heading workplaceadmin-actions-heading '>Actions</div>";str+="  <div id='"+this.container+"-actions-content' class='panel-body workplaceadmin-actions-content hidden'>";str+="   <button id='"+this.container+"-actions-onload' class='btn btn-default workplaceadmin-actions-onload'>On page load</button>";str+="  </div>";str+="</div>";str+="  <div class='workplaceadmin-buttonbar'>";str+="   <input class='btn btn-primary' id='"+this.container+"-save' value='Save' type='submit' />";str+="   <input class='btn btn-secondary' id='"+this.container+"-cancel' value='Cancel' type='submit' />";str+="  </div>";str+=" </div>";str+="</div>";str+=" <div id='"+this.container+"-config' class='workplaceadmin-config container_12'>";str+="  <div id='"+this.container+"-config-layout' class=' container-fluid'></div>";str+="  <div id='"+this.container+"-config-contexts' class='container_12 row'>";str+="   <div id='"+this.container+"-config-contexts-context' class='grid_6 col-md-6'></div>";str+="   <div id='"+this.container+"-config-contexts-links' class='grid_6 col-md-6'></div>";str+="  </div>";str+="  <div id='"+this.container+"-config-actions' class='container_12 col-md-12 hidden'>";str+="   <div class='panel panel-default'>";str+="    <div class='panel-heading'>Configure Actions</div>";str+="    <div class='panel-body'>";str+="     <div id='"+this.container+"-config-actions-new' class='container_12 col-md-12 col-sx-12'></div>";str+="     <div id='"+this.container+"-config-actions-list' class='container_12 col-md-12 col-sx-12'></div>";str+="    </div>";str+="   </div>";str+="  </div>";str+=" </div>";str+="</div>";str+="</div>";str+="</div>";document.getElementById(this.container).innerHTML=str;for(var i=0,col=0,max=this._config.widgetList.length,w;i<max;i++){w=this._config.widgetList[i];com.marklogic.widgets.dnd.onto(this.container+"-widgets-"+i+"-img","widgetclass",["layoutzone"],{type:"widgetclass",data:w.classname});}
var self=this;document.getElementById(this.container+"-page-heading").onclick=function(evt){self._showTab("page");};document.getElementById(this.container+"-widgets-heading").onclick=function(evt){self._showTab("widgets");};document.getElementById(this.container+"-contexts-heading").onclick=function(evt){self._showTab("contexts");};document.getElementById(this.container+"-actions-heading").onclick=function(evt){self._showTab("actions");};document.getElementById(this.container+"-actions-onload").onclick=function(evt){var actions=self._workplaceContext.getJson().actions.onload;self._drawActions("onload",actions);};document.getElementById(this.container+"-contexts-add-button").onclick=function(evt){var json=self._workplaceContext.getJson();var className=document.getElementById(self.container+"-contexts-add-dropdown").value;var ctxName=self._workplaceContext.nextWidgetName(className);self._workplaceContext._addWidgetName(ctxName);json.contexts.push({context:ctxName,type:className,register:[],config:{}});self._updateContextsList();};var urlsEl=document.getElementById(this.container+"-page-urls");urlsEl.onchange=function(){var val=urlsEl.value;var urls=val.split(",");console.log("URLS: "+val);self._workplaceContext.setUrls(urls);};var layoutEl=document.getElementById(this.container+"-page-layout");layoutEl.onchange=function(){var val=layoutEl.value;var newLayout=new(com.marklogic.widgets.layouts[val]||com.marklogic.widgets.layoutsext[val])(self.container+"-config-layout");var newZoneList=newLayout.getZoneList();var lastZone=newZoneList[newZoneList.length-1];var json=self._workplaceContext.getJson();var lastZoneIndex=1;for(var a=0,maxa=json.assignments.length,ass;a<maxa;a++){ass=json.assignments[a];if(ass.zone==lastZone&&ass.index>=lastZoneIndex){lastZoneIndex=ass.index+2;}}
var zoneList=self._layout.getZoneList();var missingZones=new Array();for(var z=0,maxz=zoneList.length,zone;z<maxz;z++){zone=zoneList[z];if(!newZoneList.contains(zone)){missingZones.push(zone);}}
for(var a=0,maxa=json.assignments.length,ass;a<maxa;a++){ass=json.assignments[a];if(missingZones.contains(ass.zone)){ass.zone=lastZone;ass.index=lastZoneIndex++;}}
self._workplaceContext.setLayout(val);self.updateWorkplace(self._workplaceContext);};document.getElementById(this.container+"-cancel").onclick=function(evt){self._workplaceContext.revert();self.closePublisher.publish(true);};document.getElementById(this.container+"-save").onclick=function(evt){self._persistTabChanges();self._workplaceContext.unregister(self);self._workplaceContext.save(function(result){self.closePublisher.publish(true);});};};com.marklogic.widgets.workplaceadmin.prototype._persistTabChanges=function(){if("page"==this._currentTab){this._workplaceContext.setSummary(document.getElementById(this.container+"-page-title").value,document.getElementById(this.container+"-page-urls").value.split(","),document.getElementById(this.container+"-page-layout").value,false);}
this._saveLayout();};com.marklogic.widgets.workplaceadmin.prototype._showTab=function(tab){this._persistTabChanges();mljs.defaultconnection.logger.debug("workplaceadmin._showTab: Showing "+tab);com.marklogic.widgets.hide(document.getElementById(this.container+"-page-content"),("page"!=tab));com.marklogic.widgets.hide(document.getElementById(this.container+"-widgets-content"),("widgets"!=tab));if("page"==tab||"widgets"==tab){com.marklogic.widgets.hide(document.getElementById(this.container+"-config-layout"),false);com.marklogic.widgets.hide(document.getElementById(this.container+"-config-contexts"),true);com.marklogic.widgets.hide(document.getElementById(this.container+"-config-actions"),true);}else{if("contexts"==tab){com.marklogic.widgets.hide(document.getElementById(this.container+"-config-layout"),true);com.marklogic.widgets.hide(document.getElementById(this.container+"-config-contexts"),false);com.marklogic.widgets.hide(document.getElementById(this.container+"-config-actions"),true);}else{com.marklogic.widgets.hide(document.getElementById(this.container+"-config-layout"),true);com.marklogic.widgets.hide(document.getElementById(this.container+"-config-contexts"),true);com.marklogic.widgets.hide(document.getElementById(this.container+"-config-actions"),false);}}
com.marklogic.widgets.hide(document.getElementById(this.container+"-contexts-content"),("contexts"!=tab));com.marklogic.widgets.hide(document.getElementById(this.container+"-actions-content"),("actions"!=tab));this._currentTab=tab;var pagePanelEl=document.getElementById(this.container+"-page-outer");if("page"==tab){com.marklogic.widgets.removeClass(pagePanelEl,"panel-info");com.marklogic.widgets.addClass(pagePanelEl,"panel-primary");}else{com.marklogic.widgets.removeClass(pagePanelEl,"panel-primary");com.marklogic.widgets.addClass(pagePanelEl,"panel-info");}
var widgetsPanelEl=document.getElementById(this.container+"-widgets-outer");if("widgets"==tab){com.marklogic.widgets.removeClass(widgetsPanelEl,"panel-info");com.marklogic.widgets.addClass(widgetsPanelEl,"panel-primary");}else{com.marklogic.widgets.removeClass(widgetsPanelEl,"panel-primary");com.marklogic.widgets.addClass(widgetsPanelEl,"panel-info");}
var contextsPanelEl=document.getElementById(this.container+"-contexts-outer");if("contexts"==tab){com.marklogic.widgets.removeClass(contextsPanelEl,"panel-info");com.marklogic.widgets.addClass(contextsPanelEl,"panel-primary");}else{com.marklogic.widgets.removeClass(contextsPanelEl,"panel-primary");com.marklogic.widgets.addClass(contextsPanelEl,"panel-info");}
var actionsPanelEl=document.getElementById(this.container+"-actions-outer");if("actions"==tab){com.marklogic.widgets.removeClass(actionsPanelEl,"panel-info");com.marklogic.widgets.addClass(actionsPanelEl,"panel-primary");}else{com.marklogic.widgets.removeClass(actionsPanelEl,"panel-primary");com.marklogic.widgets.addClass(actionsPanelEl,"panel-info");}};com.marklogic.widgets.workplaceadmin.prototype._saveLayout=function(){this._workplaceContext.resetWidgetConfig();for(var i=0,max=this._configWrappers.length,wrapper;i<max;i++){wrapper=this._configWrappers[i];this._workplaceContext.addWidget(wrapper.getWidgetName(),wrapper.getWidgetType(),wrapper.getWidgetConfig());}
var assignments=this._layout.generateAssignments();this._workplaceContext.setAssignments(assignments);};com.marklogic.widgets.workplaceadmin.prototype._widgetRemoved=function(data){this._layout.remove(data.widget);var pos=-1;for(var cw=0,maxcw=this._configWrappers.length,wrapper;cw<maxcw&&(-1==pos);cw++){wrapper=this._configWrappers[cw];if(wrapper.equals(data.configwrapper)){pos=cw;}}
if(-1!=pos){this._configWrappers.splice(pos,1);}
var json=this._workplaceContext.getJson();pos=-1;for(var a=0,maxa=json.assignments.length,ass;a<maxa&&(-1==pos);a++){ass=json.assignments[a];if(ass.widget==data.widget){pos=a;}}
if(-1!=pos){json.assignments.splice(pos,1);}
pos=-1;for(var w=0,maxw=json.widgets.length,wgt;w<maxw&&-1==pos;w++){wgt=json.widgets[w];if(wgt.widget==data.widget){pos=w;}}
json.widgets.splice(pos,1);for(var c=0,maxc=json.contexts.length,ctx;c<maxc;c++){ctx=json.contexts[c];pos=ctx.register.indexOf(data.widget);if(-1!=pos){ctx.register.splice(pos,1);}}};com.marklogic.widgets.workplaceadmin.prototype._addClassToZone=function(widgetclass,zone,order){var self=this;var dzElid=this._layout.createPlaceholder(zone);var insert=new com.marklogic.widgets.dropzone(dzElid);var iAss=this._layout.registerAssignment(dzElid,dzElid);this._addDzAccept(insert,iAss.zone,iAss.order,iAss.elementid);var wgtElid=this._layout.createPlaceholder(zone);var instanceName=self._workplaceContext.nextWidgetName(widgetclass);var widget=self._workplaceContext.addWidget(instanceName,widgetclass,{});var wgt=new com.marklogic.widgets.configwrapper(wgtElid);wgt.setWorkplaceContext(this._workplaceContext);var wAss=this._layout.registerAssignment(wgtElid,instanceName);this._configWrappers.push(wgt);wgt.addWidgetRemovedListener(function(data){self._widgetRemoved(data);});wgt.onto("widgetconfig",["layoutposition"],{type:"widgetconfig",data:widget});var cfg=self._workplaceContext.getWidgetInfo(widget.widget);var cls=com.marklogic.widgets.workplace._getWidgetClass(cfg.type);if(undefined!=cls.getConfigurationDefinition){cls=cls.getConfigurationDefinition();}else{cls={};}
wgt.wrap(widget.widget,widgetclass,cls,cfg.config);this._layout.moveToPosition(widget.widget,zone,order);var json=this._workplaceContext.getJson();for(var c=0,maxc=json.contexts.length,ctx;c<maxc;c++){ctx=json.contexts[c];if(undefined==ctx.register){ctx.register=new Array();}
if(!ctx.register.contains(widget.widget)){ctx.register.push(widget.widget);}}
return widget;};com.marklogic.widgets.workplaceadmin.prototype._addDzAccept=function(aDrop,zone,position,layoutelementid){mljs.defaultconnection.logger.debug("addDzAccept called for: zone: "+zone+", order: "+position+", layoutelementid: "+layoutelementid);var self=this;aDrop.accept("layoutposition",["widgetclass"],function(data){var curPos=self._layout.getAssignmentByPlaceholder(layoutelementid).item;if("widgetclass"==data.type){mljs.defaultconnection.logger.debug("APPENDING INSERT WIDGET CLASS "+data+" ON TO DROP ZONE "+zone+" OF LAYOUT AT POSITION: "+position+", WITH CURRENT ZONE: "+curPos.zone+" AND ORDER: "+curPos.order);var widget=self._addClassToZone(data.data,curPos.zone,curPos.order);}else{mljs.defaultconnection.logger.debug("layout position widgetconfig drop handler called for: "+JSON.stringify(data));self._layout.moveToPosition(data.data.widget,curPos.zone,curPos.order);}});};com.marklogic.widgets.workplaceadmin.prototype.updateWorkplace=function(ctx){var json=this._workplaceContext.getJson();var self=this;if(undefined==json){console.log("WARNING: workplaceadmin.updateWorkplace: ctx json null!");return;}
mljs.defaultconnection.logger.debug("workplaceadmin.updateWorkplace: Creating layout");mljs.defaultconnection.logger.debug("workplaceadmin.updateWorkplace: Got JSON: "+JSON.stringify(json));this._layout=new(com.marklogic.widgets.layouts[json.layout]||com.marklogic.widgets.layoutsext[json.layout])(this.container+"-config-layout");com.marklogic.widgets.hide(document.getElementById(this.container+"-config-layout"),false);com.marklogic.widgets.hide(document.getElementById(this.container+"-config-contexts"),true);var zones=this._layout.getZoneList();var zoneWidgets={};for(var z=0,maxz=zones.length,zone;z<maxz;z++){zone=zones[z];var zarray=zoneWidgets[zone];if(undefined==zarray){zarray=[];zoneWidgets[zone]=zarray;}
for(var a=0,maxa=json.assignments.length,ass;a<maxa;a++){ass=json.assignments[a];if(ass.zone==zone){zarray.push(ass);}}
bubbleSort(zarray,"order",true);}
var addBottomDz=function(zone){var dzElid=self._layout.createPlaceholder(zone);var bDrop=new com.marklogic.widgets.dropzone(dzElid);self._layout.registerAssignment(dzElid,dzElid);bDrop.accept("layoutposition",["widgetclass","widgetconfig"],function(data){console.log("APPENDING WIDGET CLASS "+data+" ON TO DROP ZONE "+zone+" OF LAYOUT");if("widgetclass"==data.type){self._addClassToZone(data.data,zone);}else{var curPos=self._layout.getAssignmentByPlaceholder(dzElid).item;self._layout.moveToPosition(data.data.widget,curPos.zone,curPos.order);}});};for(var z=0,maxz=zones.length,zone;z<maxz;z++){zone=zones[z];for(var w=0,maxw=zoneWidgets[zone].length,widget;w<maxw;w++){widget=zoneWidgets[zone][w];var dzElid=this._layout.createPlaceholder(zone);var aDrop=new com.marklogic.widgets.dropzone(dzElid);var dzAss=this._layout.registerAssignment(dzElid,dzElid);var wgtElid=this._layout.createPlaceholder(zone);var wgt=new com.marklogic.widgets.configwrapper(wgtElid);wgt.setWorkplaceContext(this._workplaceContext);var wgtAss=this._layout.registerAssignment(wgtElid,widget.widget);wgt.addWidgetRemovedListener(function(data){self._widgetRemoved(data);});this._addDzAccept(aDrop,zone,dzAss.order,dzElid);this._configWrappers.push(wgt);wgt.onto("widgetconfig",["layoutposition"],{type:"widgetconfig",data:widget});var cfg=this._workplaceContext.getWidgetInfo(widget.widget);var cls=com.marklogic.widgets.workplace._getWidgetClass(cfg.type);if(undefined!=cls.getConfigurationDefinition){cls=cls.getConfigurationDefinition();}else{cls={};}
wgt.wrap(widget.widget,cfg.type,cls,cfg.config);}
addBottomDz(zone);}
document.getElementById(this.container+"-page-title").value=json.title;var str="";for(var i=0;i<json.urls.length;i++){if(i>0){str+=",";}
str+=json.urls[i];}
document.getElementById(this.container+"-page-urls").innerHTML=str;document.getElementById(this.container+"-page-layout").value=json.layout;this._updateContextsList();this._layout.printZoneInfo();mljs.defaultconnection.logger.debug("workplaceadmin.updateWorkplace: Finished creating layout");};com.marklogic.widgets.workplaceadmin.prototype._updateContextsList=function(){var self=this;var json=this._workplaceContext.getJson();var contexts=json.contexts;var contextListEl=document.getElementById(this.container+"-contexts-list");var ctxStr="";for(var c=0,maxc=contexts.length,ctx;c<maxc;c++){ctx=contexts[c];ctxStr+="<div class='btn-toolbar'>";ctxStr+="<div id='"+this.container+"-context-"+ctx.context+"' class='btn-group workplaceadmin-contexts-listitem'>";ctxStr+="<button type='button' class='btn btn-danger' id='"+this.container+"-context-name-"+ctx.context+"-del'>";ctxStr+="<span class='glyphicon glyphicon-remove workplaceadmin-contexts-removecontext btn-fix'></span>";ctxStr+="</button>";ctxStr+="<button class='btn btn-default'>";ctxStr+="<span class='workplaceadmin-contexts-listitem-text'>";ctxStr+=ctx.context;ctxStr+="</span> ";ctxStr+="</button>";ctxStr+="</div>";ctxStr+="</div>";}
contextListEl.innerHTML=ctxStr;var addDelHandler=function(ctx){var divelid=self.container+"-context-"+ctx.context;var elid=self.container+"-context-name-"+ctx.context+"-del";var delel=document.getElementById(elid);delel.onclick=function(evt){self._workplaceContext.removeContext(ctx.context);var thediv=document.getElementById(divelid);thediv.parentNode.removeChild(thediv);};};var addCtxHandler=function(ctxEl,ctxjson){ctxEl.onclick=function(event){var wrapper=new com.marklogic.widgets.configwrapper(self.container+"-config-contexts-context");wrapper.setWorkplaceContext(self._workplaceContext);wrapper.hideRemoveButton();var widgetClass=self._workplaceContext.getContextClass(ctxjson.type);var classConfig=widgetClass.getConfigurationDefinition();wrapper.wrap(ctxjson.context,ctxjson.type,classConfig,ctxjson.config);var mine=new Array();var str="<div class='mljswidget panel panel-default config-context-links'>"
str+="<div class='panel-heading'>Widgets to Register</div>";str+="<div class='panel-body'>";str+="<select size='10' multiple='multiple' id='"+self.container+"-config-contexts-links-link'>";for(var w=0,maxw=json.widgets.length,wgt;w<maxw;w++){wgt=json.widgets[w];str+="<option ";if(ctxjson.register.contains(wgt.widget)){str+="selected='selected' ";}
str+="value='"+wgt.widget+"'>"+wgt.widget+"</widget>";}
str+="</select></div></div>";document.getElementById(self.container+"-config-contexts-links").innerHTML=str;var selEl=document.getElementById(self.container+"-config-contexts-links-link");selEl.onchange=function(evt){ctxjson.register=com.marklogic.widgets.getSelectValues(selEl);};com.marklogic.widgets.hide(document.getElementById(self.container+"-config-layout"),true);com.marklogic.widgets.hide(document.getElementById(self.container+"-config-contexts"),false);event.stopPropagation();return false;};};for(var c=0,maxc=contexts.length,ctx;c<maxc;c++){ctx=contexts[c];var ctxEl=document.getElementById(self.container+"-context-"+ctx.context);addCtxHandler(ctxEl,ctx);addDelHandler(ctx);}};com.marklogic.widgets.workplaceadmin.prototype._drawActions=function(actionListName,actions){var creator=new com.marklogic.widgets.actioncreator(this.container+"-config-actions-new");var orderedconfig=new com.marklogic.widgets.orderedconfig(this.container+"-config-actions-list");var self=this;orderedconfig.addOrderChangeListener(function(oc){self._workplaceContext.setActionList(actionListName,oc);});orderedconfig.readOnly([{type:"javascript",readonly:["target","method"]}]);orderedconfig.dropzones(true,false);var jsdefs={javascript:{target:{type:"instance",default:null,title:"Target",description:"Class to call method on"},method:{type:"method",default:null,title:"Method",description:"Method name to call"},parameters:{type:"multiple",default:[],minimum:0,title:"Parameters",description:"Method Parameters",childDefinitions:{type:{type:"jstype",default:"string",title:"Type",description:"Parameter type"},value:{type:"jsvalue",default:null,title:"Value",description:"Parameter value"}}}}};var actions=this._workplaceContext.getJson().actions;var actionList=[];if(undefined!=actions){var list=actions[actionListName];if(undefined!=list&&Array.isArray(list)){actionList=list;}}
this._workplaceContext.setActionList(actionListName,actionList);orderedconfig.configure(actionList,jsdefs,"action");creator.addActionCreatedListener(function(actionJson){actionList.push(actionJson);self._workplaceContext.setActionList(actionListName,actionList);orderedconfig.append(actionJson);});creator.updateWorkplace(this._workplaceContext);orderedconfig.updateWorkplace(this._workplaceContext);};com.marklogic.widgets.orderedconfig=function(container){this.container=container;this._workplaceContext=null;this._title="Actions";this._readonly=new Array();this._drawOrderDropzones=true;this._drawNewDropzone=true;this._allowRemoval=true;this._nameJsonPath="name";this._nextidx=0;this._ordered=new com.marklogic.util.linkedlist();this._orderChangePublisher=new com.marklogic.events.Publisher();};com.marklogic.widgets.orderedconfig.prototype.updateWorkplace=function(ctx){this._workplaceContext=ctx;this._refresh();};com.marklogic.widgets.orderedconfig.prototype.addOrderChangeListener=function(func){this._orderChangePublisher.subscribe(func);};com.marklogic.widgets.orderedconfig.prototype.removeOrderChangeListener=function(func){this._orderChangePublisher.unsubscribe(func);};com.marklogic.widgets.orderedconfig.prototype.readOnly=function(roArray){this._readonly=roArray;};com.marklogic.widgets.orderedconfig.prototype.title=function(title){this._title=title;};com.marklogic.widgets.orderedconfig.prototype.dropzones=function(drawOrderDropzones,drawNewDropzone){this._drawOrderDropzones=drawOrderDropzones;this._drawNewDropzone=drawNewDropzone;};com.marklogic.widgets.orderedconfig.prototype.configure=function(instances,definitions,nameJsonPath){this._definitions=definitions;this._instances=instances;this._nameJsonPath=nameJsonPath;this._refresh();};com.marklogic.widgets.orderedconfig.prototype._fireNewOrder=function(){var oconfig=new Array();var ordered=this._ordered.getOrderedItems();for(var i=0,maxi=ordered.length,item;i<maxi;i++){item=ordered[i];oconfig.push(item.getValue().config);}
this._orderChangePublisher.publish(oconfig);};com.marklogic.widgets.orderedconfig.prototype._refresh=function(){this._ordered=new com.marklogic.util.linkedlist();var s="<div id='"+this.container+"-orderedconfig' class='mljswidget panel panel-default orderedconfig'>";s+="<div class='panel-heading'>"+this._title+"</div><div class='panel-body' id='"+this.container+"-list'>";if(null!=this._workplaceContext){for(var a=0,maxa=this._instances.length,inst;a<maxa;a++){inst=this._instances[a];var res=this._addConfig(inst,a);s+=res.html;}
this._nextidx=maxa;if(true===this._drawNewDropzone){s+=" <div id='"+this.container+"-appenddz'></div>";}
s+="</div></div>";}
document.getElementById(this.container).innerHTML=s;var self=this;var item=this._ordered.forEach(function(item){self._addWrapper(item);});};com.marklogic.widgets.orderedconfig.prototype.append=function(actionJson){var item=this._addConfig(actionJson,this._nextidx++);var el=document.getElementById(this.container+"-list");com.marklogic.widgets.appendHTML(el,item.html);this._addWrapper(item.item);};com.marklogic.widgets.orderedconfig.prototype._addConfig=function(json,idx){var s="";var inst=null;var def=this._definitions[json.type];var elid=this.container+"-item-"+idx;s+="<div id='"+elid+"'>";s+=" <div id='"+elid+"-dz'></div>";s+=" <div id='"+elid+"-config'></div>";s+="</div>";inst={html:s,item:this._ordered.append(json[this._nameJsonPath],{config:json.config,type:json.type,def:def,element:elid})};return inst;};com.marklogic.widgets.orderedconfig.prototype._addWrapper=function(item){var self=this;var value=item.getValue();var dz=new com.marklogic.widgets.dropzone(value.element+"-dz");var wrapper=new com.marklogic.widgets.configwrapper(value.element+"-config");wrapper.addWidgetRemovedListener(function(data){self._ordered.remove(item.getName());var meel=document.getElementById(item.getValue().element);meel.parentNode.removeChild(meel);self._fireNewOrder();});wrapper.setWorkplaceContext(this._workplaceContext);wrapper.wrap(item.getName(),value.type,value.def,value.config);};com.marklogic.widgets.dropzone=function(container){this.container=container;this._accepted=[];this._callback=null;this._init();};com.marklogic.widgets.dropzone.prototype._init=function(){var str="<div class='mljswidget panel panel-info dropzone'>";str+=" <div class='dropzone-target' id='"+this.container+"-target'>";str+="<p class='dropzone-text'><span class='glyphicon glyphicon-download'></span> Drop here</p>";str+=" </div>";str+="</div>";document.getElementById(this.container).innerHTML=str;};com.marklogic.widgets.dropzone.prototype.accept=function(dropzoneClass,draggableTypeAcceptArray,callback){com.marklogic.widgets.dnd.accept(this.container+"-target",dropzoneClass,draggableTypeAcceptArray,callback);};com.marklogic.widgets.configwrapper=function(container){this.container=container;mljs.defaultconnection.logger.debug("configwrapper: Constructor: Creating configwrapper within element with id: "+container);this._widgetName="";this._configDescription=null;this._config=null;this._type=null;this._deleteHidden=false;this._workplaceContext=null;this.__nextID=1;this._removedPublisher=new com.marklogic.events.Publisher();this._init();};com.marklogic.widgets.configwrapper.prototype.equals=function(otherconfigwrapper){return(this._widgetName==otherconfigwrapper._widgetName);};com.marklogic.widgets.configwrapper.prototype.addWidgetRemovedListener=function(func){this._removedPublisher.subscribe(func);};com.marklogic.widgets.configwrapper.prototype.removeWidgetRemovedListener=function(func){this._removedPublisher.unsubscribe(func);};com.marklogic.widgets.configwrapper.prototype.getWidgetName=function(){return this._widgetName;};com.marklogic.widgets.configwrapper.prototype.getWidgetType=function(){return this._type;};com.marklogic.widgets.configwrapper.prototype.getWidgetConfig=function(){return this._config;};com.marklogic.widgets.configwrapper.prototype.setWorkplaceContext=function(wpc){this._workplaceContext=wpc;};com.marklogic.widgets.configwrapper.prototype.getWorkplaceContext=function(){return this._workplaceContext;};com.marklogic.widgets.configwrapper.prototype.onto=function(draggableClass,droppableTypeAcceptArray,dataOrCallback){mljs.defaultconnection.logger.debug("configwrapper.onto: Adding drag handler for "+this.container+"-name");com.marklogic.widgets.dnd.onto(this.container+"-name",draggableClass,droppableTypeAcceptArray,dataOrCallback);};com.marklogic.widgets.configwrapper.prototype.wrap=function(widgetName,classname,configDescription,currentConfig){this._widgetName=widgetName;this._configDescription=configDescription;this._config=currentConfig;this._type=classname;this._updateWidgetConfig();};com.marklogic.widgets.configwrapper.prototype._updateWidgetConfig=function(){document.getElementById(this.container+"-name").innerHTML=this._widgetName;this._genConfigHTML(this._config,this._configDescription,0,this.container+"-cfg");};com.marklogic.widgets.configwrapper.prototype._genConfigHTMLConf=function(json,def,level,name,confslist){var str="";var c=undefined;if(undefined!=json){c=json[name];}
var d=def[name];str+="<div class='form-group'>";var addtitle=function(){str+="<label title='"+d.description+"'>"+d.title+"</label>";};var conf={id:this.__nextID++,json:c,def:d,str:""};var self=this;var usedDefault=false;if("string"==d.type||"double"==d.type||"jsvalue"==d.type||"method"==d.type){addtitle();var val=c;if(undefined==c){val=d.default;usedDefault=true;}
if(null==c){val="";json[name]="";usedDefault=false;}
if("object"==typeof(val)){val=JSON.stringify(val);}
str+="<input class='form-control' type='text' id='"+this.container+"-"+conf.id+"' value='"+val.htmlEscape()+"' />";conf.addhandler=function(){var el=document.getElementById(self.container+"-"+conf.id);el.onchange=function(){json[name]=el.value;};};}else if("enum"==d.type){addtitle();var val=c;if(undefined==c){val=d.default;usedDefault=true;}
var hasSelected=false;str+="<select class='form-control' id='"+this.container+"-"+conf.id+"'>";for(var i=0,opt,max=d.options.length;i<max;i++){opt=d.options[i];str+="<option value='"+opt.value+"' title='"+opt.description+"' ";if(opt.value===val){str+="selected='selected' ";hasSelected=true;}
str+=">"+opt.title+"</option>";}
if(!hasSelected&&undefined!=d.options[0]){json[name]=d.options[0].value;usedDefault=false;}
str+="</select>";conf.addhandler=function(){var el=document.getElementById(self.container+"-"+conf.id);el.onchange=function(){json[name]=el.value;};};}else if("positiveInteger"==d.type||"integer"==d.type||"double"==d.type||"float"==d.type){var checkers={positiveInteger:function(value){return((""+value)==(""+Math.floor(value)))&&((undefined==d.minimum)||(undefined!=d.minimum&&value>=d.minimum))&&((undefined==d.maximum)||(undefined!=d.maximum&&value<=d.maximum))&&value>=0;},integer:function(value){return((""+value)==(""+Math.floor(value)))&&((undefined==d.minimum)||(undefined!=d.minimum&&value>=d.minimum))&&((undefined==d.maximum)||(undefined!=d.maximum&&value<=d.maximum));},double:function(value){return(""+(1.0*value))==value;},float:function(value){return(""+(1.0*value))==value;}};var myChecker=checkers[d.type];addtitle();var val=c;if(undefined==c){val=""+d.default;usedDefault=true;}else{val=""+val;}
str+="<div class='input-group'>";str+="<input class='form-control' type='text' id='"+self.container+"-"+conf.id+"' value='"+val.htmlEscape()+"' />";str+="<div class='input-group-addon glyphicon glyphicon-minus configwrapper-decrement' id='"+self.container+"-"+conf.id+"-decrement'></div>";str+="<div class='input-group-addon glyphicon glyphicon-plus configwrapper-increment' id='"+self.container+"-"+conf.id+"-increment'></div>";str+="</div>";conf.addhandler=function(){var el=document.getElementById(self.container+"-"+conf.id);el.onchange=function(){var val=el.value;try{if(myChecker(val)){mljs.defaultconnection.logger.debug("configwrapper: positiveInteger.onchange: Valid valud: "+val+" for "+name);json[name]=val;}else{mljs.defaultconnection.logger.debug("configwrapper: positiveInteger.onchange: Invalid valid: "+val+" for "+name+", resetting to: "+json[name]);el.value=json[name];}}catch(numberex){mljs.defaultconnection.logger.debug("configwrapper: positiveInteger.onchange: Number exception: "+numberex+" for "+name);el.value=json[name];}};};}else if("boolean"==d.type){addtitle();var val=c;if(undefined==c){val=d.default;usedDefault=true;}
str+="<input class='form-control' type='checkbox' name='"+this.container+"-"+conf.id+"' id='"+this.container+"-"+conf.id+"' ";if(true===val){str+="checked='checked' ";}
str+="/>";conf.addhandler=function(){var el=document.getElementById(self.container+"-"+conf.id);el.onchange=function(){json[name]=el.checked;};};}else if("multiple"==d.type){str+="<div class='configwrapper-multiple-firstrow'>";str+="<label>"+d.title+"</label>&nbsp;&nbsp;&nbsp;&nbsp;";str+="<button class='btn btn-default btn-sm' id='"+this.container+"-"+conf.id+"-add'>";str+="<span class='glyphicon glyphicon-plus btn-fix-sm configwrapper-addmultiple'></span>";str+="</button>";conf.addhandler=function(){var el=document.getElementById(self.container+"-"+conf.id+"-add");el.onclick=function(){var cjson={};for(var didx=0,maxdidx=conf.def.childDefinitions.length,defItem;didx<maxdidx;didx++){defItem=conf.def.childDefinitions[didx];for(var item in defItem){cjson[item]=defItem[item].default;}}
json[name].push(cjson);self._updateWidgetConfig();};};str+="</div>";str+="<div class='configwrapper-multiple-indent'>";str+="<table class='configwrapper-multiple-table' id='"+this.container+"-"+conf.id+"-table'>";var dels=new Array();if(Array.isArray(c)){var gotrows=false;for(var i=0;i<c.length;i++){gotrows=true;str+="<tr id='"+this.container+"-"+conf.id+"-row-"+i+"'><td>";str+="<button id='"+this.container+"-"+conf.id+"-del-"+i+"' class='btn btn-danger btn-sm'>";str+="<span class='glyphicon glyphicon-remove btn-fix-sm configwrapper-delmultiple' ></span>";str+="</button>"+(i+1)+": ";str+="</td><td>";str+=this._genConfigHTMLInner(c[i],d.childDefinitions,level+1,confslist);dels.push({elid:this.container+"-"+conf.id+"-del-"+i,json:c[i],def:d.childDefinitions,parentJson:c,index:i,id:conf.id});str+="</td></tr>";}
if(!gotrows){}
self._addMultiHandler(c,d,conf,level,dels);}else{json[name]=[];}
str+="</table>";str+="</div>";}else if("jstype"==d.type){var instances=["null","string","number","instance","queryStringParameter"];addtitle();var val=c;var hasSelected=false;if(undefined==c){val=d.default;usedDefault=true;}
str+="<select class='form-control' id='"+this.container+"-"+conf.id+"'>";for(var i=0,opt,max=instances.length;i<max;i++){opt=instances[i];str+="<option value='"+opt+"' title='"+opt+"' ";if(opt===val){str+="selected='selected' ";hasSelected=true;}
str+=">"+opt+"</option>";}
if(!hasSelected&&undefined!=instances[0]){json[name]=instances[0];usedDefault=false;}
str+="</select>";conf.addhandler=function(){var el=document.getElementById(self.container+"-"+conf.id);el.onchange=function(){json[name]=el.value;};};}else if("instance"==d.type){var instances=this._workplaceContext.getInstances();addtitle();var val=c;var hasSelected=false;if(undefined==c){val=d.default;usedDefault=true;}
str+="<select class='form-control' id='"+this.container+"-"+conf.id+"'>";for(var i=0,opt,max=instances.length;i<max;i++){opt=instances[i];str+="<option value='"+opt+"' title='"+opt+"' ";if(opt===val){str+="selected='selected' ";hasSelected=true;}
str+=">"+opt+"</option>";}
if(!hasSelected&&undefined!=instances[0]){json[name]=instances[0];usedDefault=false;}
str+="</select>";conf.addhandler=function(){var el=document.getElementById(self.container+"-"+conf.id);el.onchange=function(){json[name]=el.value;};};}else{var cls=this._workplaceContext.getContextClass(d.type);if(null!=cls){var instances=this._workplaceContext.getInstancesOf(d.type);addtitle();var val=c;var hasSelected=false;if(undefined==c){val=d.default;usedDefault=true;}
str+="<select class='form-control' id='"+this.container+"-"+conf.id+"'>";for(var i=0,opt,max=instances.length;i<max;i++){opt=instances[i];str+="<option value='"+opt+"' title='"+opt+"' ";if(opt===val){str+="selected='selected' ";hasSelected=true;}
str+=">"+opt+"</option>";}
if(!hasSelected&&undefined!=instances[0]){json[name]=instances[0];usedDefault=false;}
str+="</select>";conf.addhandler=function(){var el=document.getElementById(self.container+"-"+conf.id);el.onchange=function(){json[name]=el.value;};};}else{console.log("WARNING: UNKNOWN d.type: "+d.type);}}
if(usedDefault){json[name]=d.default;}
str+="</div>";confslist.push(conf);return str;};com.marklogic.widgets.configwrapper.prototype._addDelHandler=function(del,c){var self=this;mljs.defaultconnection.logger.debug("In addDelHandler");var delEl=document.getElementById(del.elid);delEl.onclick=function(evt){c.splice(del.index,1);var row=document.getElementById(self.container+"-"+del.id+"-row-"+del.index);row.parentNode.removeChild(row);};mljs.defaultconnection.logger.debug("End addDelHandler");};com.marklogic.widgets.configwrapper.prototype._addMultiHandler=function(c,d,conf,level,dels){var self=this;conf.addhandler=function(){mljs.defaultconnection.logger.debug("In multiple.addhandler");var addEl=document.getElementById(self.container+"-"+conf.id+"-add");addEl.onclick=function(evt){c.push({});var parentEl=document.getElementById(self.container+"-"+conf.id+"-table");var rowElId=self.container+"-"+conf.id+"-row-"+(c.length-1);var elid=rowElId+"-content";var newStr="<td>"+(c.length)+":&nbsp;<br/><span class='configwrapper-delmultiple' id='"+self.container+"-"+conf.id+"-del-"+(c.length-1)+"'>&nbsp;</span></td><td id='"+elid+"'></td>";var tr=document.createElement("tr");tr.setAttribute("id",rowElId);parentEl.appendChild(tr);tr.innerHTML=newStr;self._addDelHandler({elid:self.container+"-"+conf.id+"-del-"+(c.length-1),json:c[c.length-1],def:d.childDefinitions,parentJson:c,index:c.length-1,id:conf.id},c);mljs.defaultconnection.logger.debug("calling genconfightml with c: "+JSON.stringify(c[c.length-1])+", d.childDefinitions: "+
JSON.stringify(d.childDefinitions)+", level: "+(level+1)+", elid: "+elid+", d: "+JSON.stringify(d));self._genConfigHTML(c[c.length-1],d.childDefinitions,level+1,elid);};for(var de=0,maxd=dels.length,del;de<maxd;de++){del=dels[de];self._addDelHandler(del,c);}
mljs.defaultconnection.logger.debug("End multiple.addhandler");};};com.marklogic.widgets.configwrapper.prototype._genConfigHTML=function(json,def,level,elid){var confslist=new Array();document.getElementById(elid).innerHTML=this._genConfigHTMLInner(json,def,level,confslist);for(var c=0,maxc=confslist.length,conf;c<maxc;c++){conf=confslist[c];if(undefined!=conf.addhandler){conf.addhandler();}}};com.marklogic.widgets.configwrapper.prototype._genConfigHTMLInner=function(json,def,level,confslist){var gotConfig=false;var str="<table class='configwrapper-table'>";for(var name in def){gotConfig=true;str+=this._genConfigHTMLConf(json,def,level,name,confslist);}
if(!gotConfig){str+="<tr><td><i>This widget cannot be configured</i></td></tr>";}
str+="</table>";return str;};com.marklogic.widgets.configwrapper.prototype.hideRemoveButton=function(hideme){com.marklogic.widgets.hide(document.getElementById(this.container+"-name-del"),hideme||true);};com.marklogic.widgets.configwrapper.prototype._init=function(){var str="<div class='mljswidget panel panel-default configwrapper'>";str+="<div class='panel-heading'>"
str+=" <button class='btn btn-danger btn-sm configwrapper-delete' id='"+this.container+"-name-del'>";str+="<span class='glyphicon glyphicon-remove btn-fix-sm'></span>";str+="</button> ";str+=" <span class='configwrapper-heading' draggable='true' id='"+this.container+"-name'>";str+=this._widgetName+"</span>";str+="</div>";str+="<div id='"+this.container+"-cfg' class='panel-body'>";str+="</div>";str+="</div>";document.getElementById(this.container).innerHTML=str;var delEl=document.getElementById(this.container+"-name-del");var self=this;delEl.onclick=function(evt){self._removedPublisher.publish({widget:self._widgetName,configwrapper:self});};this._genConfigHTML(this._config,this._configDescription,0,this.container+"-cfg");};com.marklogic.widgets.configwrapper.prototype.updateWorkplace=function(json){this._updateWidgetConfig();};com.marklogic.widgets.actionorderer=function(container){this.container=container;this._workplaceContext=null;this._actions=null;this._wrappers={};this._init();};com.marklogic.widgets.actionorderer.prototype._init=function(){var s="<div class='mljswidget actionorderer' id='"+this.container+"-outer'>";s+="  <div class='actionorderer-actions' id='"+this.container+"-actions'></div>";s+="  <div class='actionorderer-drop' id='"+this.container+"-drop'></div>";s+="</div>";document.getElementById(this.container).innerHTML=s;};com.marklogic.widgets.actionorderer.prototype.setWorkplaceContext=function(ctx){this._workplaceContext=ctx;};com.marklogic.widgets.actionorderer.prototype.updateWorkplace=function(ctx){this._workplaceContext=ctx;};com.marklogic.widgets.actionorderer.prototype.wrap=function(actions){this._actions=actions;this._configs=configs;var el=document.getElementById(this.container+"-actions");el.innerHTML="";var s="";for(var a=0,maxa=actions.length,action;a<maxa;a++){action=actions[a];s+="<div id='"+this.container+"-action-"+a+"'></div>";}
el.innerHTML=s;for(var a=0,maxa=actions.length,action;a<maxa;a++){action=actions[a];var htmlid=this.container+"-action-"+a;var wrapper=new com.marklogic.widgets.configwrapper(htmlid);wrapper.setWorkplaceContext(this._workplaceContext);var desc=null;var actionClassType;for(var c=0,maxc=configs.length,config;c<maxc;c++){config=configs[c];if(config.targetClass==action.config.target){wrapper.wrap(action.action,action.type,desc,action.config);}}}};com.marklogic.widgets.actionorderer.prototype.getActions=function(){return this._actions;};com.marklogic.widgets.actioncreator=function(container){this.container=container;this._workplaceContext=null;this._currentObject=null;this._currentFunction=null;this._init();this._newActionPublisher=new com.marklogic.events.Publisher();};com.marklogic.widgets.actioncreator.prototype._init=function(){var str="<div class='mljswidget actioncreator' id='"+this.container+"-actioncreator'>";str+="    Object: <select class='actioncreator-object' id='"+this.container+"-object'></select> ";str+="    Function: <select class='actioncreator-function' id='"+this.container+"-function'></select> ";str+="    <button id='"+this.container+"-button' class='btn btn-default actioncreator-add'><span class='glyphicon glyphicon-plus btn-fix'></span></button>";str+="   </div>";document.getElementById(this.container).innerHTML=str;var self=this;var objEl=document.getElementById(this.container+"-object");objEl.onchange=function(evt){self._currentObject=objEl.value;self._refreshFunctionList(self._currentFunction);};var funcEl=document.getElementById(this.container+"-function");funcEl.onchange=function(evt){self._currentFunction=funcEl.value;}
var but=document.getElementById(this.container+"-button");but.onclick=function(evt){var classInstance=document.getElementById(self.container+"-object").value;var funcName=document.getElementById(self.container+"-function").value;if(null==classInstance||null==funcName){}else{var name=classInstance+"."+funcName;var json={type:"javascript",action:name,config:{target:classInstance,method:funcName,parameters:[]}};self._newActionPublisher.publish(json);}
evt.stopPropagation();return false;};};com.marklogic.widgets.actioncreator.prototype._refreshObjectList=function(toHighlight){console.log("AC: _refreshObjectList");var str="";var otm=this._workplaceContext.getObjectTypes();var curValue=null;for(var objname in otm){obj=otm[objname];str+="<option value='"+objname+"'";if(objname==toHighlight){str+=" selected='selected'";curValue=objname;}
str+=">"+objname+"</option>";}
str=="<option value='__other'>Other...</option>";var el=document.getElementById(this.container+"-object");el.innerHTML=str;if(null==curValue){curValue=el.value;}
this._currentObject=curValue;this._refreshFunctionList();};com.marklogic.widgets.actioncreator.prototype._refreshFunctionList=function(toHighlight){console.log("AC: _refreshFunctionList");var el=document.getElementById(this.container+"-function");if(null==this._currentObject){return;}
var newFunc=null;var s="";console.log("AC: Fetching object type for: "+this._currentObject);var typeHighlight=this._workplaceContext.getObjectType(this._currentObject);console.log("AC: type to highlight: "+typeHighlight);var actions=this._workplaceContext.getActionDescriptions();for(var t=0,maxt=actions.length,action;t<maxt;t++){action=actions[t];if(action.targetClass==typeHighlight){s+="<option value='"+action.methodName+"' ";if(action.methodName==toHighlight){s+="selected='selected' ";newFunc=action.methodName;}
s+=">"+action.methodName+"</option>";}}
el.innerHTML=s;this._currentFunc=newFunc;if(null==this._currentFunc){this._currentFunc=el.value;}};com.marklogic.widgets.actioncreator.prototype.updateWorkplace=function(ctx){this._workplaceContext=ctx;this._refreshObjectList(this._currentObject);this._refreshFunctionList(this._currentFunction);};com.marklogic.widgets.actioncreator.prototype.addActionCreatedListener=function(lisfunc){this._newActionPublisher.subscribe(lisfunc);};com.marklogic.widgets.actioncreator.prototype.removeActionCreatedListener=function(lisfunc){this._newActionPublisher.unsubscribe(lisfunc);};com.marklogic.widgets.actionconfig=function(container){this.container=container;this._config=null;this._type=null;this._init();};com.marklogic.widgets.actionconfig.prototype._init=function(){var str="<div class='mljswidget actionconfig' id='"+this.container+"-actionconfig'>";str+=" <div class='actionconfig-header'>";str+="  <span>DEL</span>";str+="  <span class='subtitle' id='"+this.container+"-actionconfig-title'></span>";str+=" </div>";str+=" <div class='actionconfig-params'>";str+="  <i>No Parameters</i> <span>ADD</span>";str+=" </div>";str+="</div>";document.getElementById(this.container).innerHTML=str;};com.marklogic.widgets.actionconfig.prototype.wrap=function(config){this._config=config;};com.marklogic.widgets.actionconfig.prototype.getConfig=function(){return this._config;};com.marklogic.widgets.workplacenavbar=function(container){this.container=container;this._workplaceContext=null;this._config={appName:"Workplace",homeUrl:"/index.html5",homeText:"Home",showAppConfigureLink:true,appConfigureLinkText:"Configure App",appConfigureUrl:"/application.html5",showPageConfigureLink:true,pageConfigureLinkText:"Configure Page",showLogoutLink:false,logoutLinkText:"Logout",logoutUrl:"/logout"};this._refresh();};com.marklogic.widgets.workplacenavbar.prototype.setWorkplaceContext=function(ctx){mljs.defaultconnection.logger.debug("workplacenavbar.setWorkplaceContext: called.");this._workplaceContext=ctx;};com.marklogic.widgets.workplacenavbar.prototype.getWorkplaceContext=function(){return this._workplaceContext;};com.marklogic.widgets.workplacenavbar.getConfigurationDefinition=function(){return{appName:{type:"string",default:"Workplace",title:"Application name",description:"Default application name (normally read from workplace app JSON)"},homeUrl:{type:"string",default:"/index.html5",title:"Home link URL",description:"Absolute URL of the home page. Blank for no home page link"},homeText:{type:"string",default:"Home",title:"Home link text",description:"The display text for the link"},showAppConfigureLink:{type:"boolean",default:true,title:"Show App Configure Link",description:"Show application configuration link"},appConfigureLinkText:{type:"string",default:"Configure App",title:"App Configure Link Text",description:"The display text for the link"},appConfigureUrl:{type:"string",default:"/application.html5",title:"Configure App Url",description:"The URL of the page managing app wide configuration"},showPageConfigureLink:{type:"boolean",default:true,title:"Show Page Configure Link",description:"Whether to show the link for this page's configuration"},pageConfigureLinkText:{type:"string",default:"Configure Page",title:"Page Configure Link Text",description:"The display text for the link"},showLogoutLink:{type:"boolean",default:false,title:"Show Logout Link",description:"Whether to show a link to the logout page"},logoutLinkText:{type:"string",default:"Logout",title:"Logout Link Text",description:"The display text for the link"},logoutUrl:{type:"string",default:"/logout",title:"Logout Link Url",description:"The URL for the logout handling server side process"}}};com.marklogic.widgets.workplacenavbar.prototype.setConfiguration=function(config){for(var prop in config){this._config[prop]=config[prop];}
this._refresh();};com.marklogic.widgets.workplacenavbar.prototype._refresh=function(){var s="<div class='mljswidget navbar navbar-default workplacenavbar' role='navigation'>";if(null!=this._config.homeUrl&&""!=this._config.homeUrl.trim()){s+="<div class='container'>"
s+="<div class='navbar-header'>"
s+="<button type='button' class='navbar-toggle' data-toggle='collapse' data-target='.navbar-collapse'>"
s+="<span class='sr-only'>Toggle navigation</span>"
s+="<span class='icon-bar'></span>"
s+="<span class='icon-bar'></span>"
s+="<span class='icon-bar'></span>"
s+="</button>"
s+="<a class='navbar-brand' href='"+this._config.homeUrl+"'>"+this._config.appName+"</a>"
s+="</div>";}
s+="<div class='navbar-collapse collapse'><ul class='nav navbar-nav'>";if(null!=this._config.homeUrl&&""!=this._config.homeUrl.trim()){s+="<li";if(-1!=this._config.homeUrl.indexOf(window.location.pathname)){s+=" class='active'";}
s+="><a href='"+this._config.homeUrl+"'>"+this._config.homeText+"</a></li>";}
if(null!=this._workplaceContext){var pages=this._workplaceContext.getCachedPages();for(var i=0,maxi=pages.length,page;i<maxi;i++){page=pages[i];if(undefined!=page.page.urls&&Array.isArray(page.page.urls)&&page.page.urls.length>0){s+="<li";if(page.page.urls.contains(window.location.pathname)){s+=" class='active'";}
s+="><a href='"+page.page.urls[0]+"'>"+page.page.title+"</a></li>";}}}
s+="</ul><ul class='nav navbar-nav navbar-right'>";if(true===this._config.showAppConfigureLink){s+="<li";if(-1!=this._config.appConfigureUrl.indexOf(window.location.pathname)){s+=" class='active'";}
s+="><a id="+this.container+"-workplacenavbar-configureapp' href='"+this._config.appConfigureUrl+"'>"+this._config.appConfigureLinkText+"</a></li>";}
s+="<li><a href='#' id='"+this.container+"-workplacenavbar-configurepage'>"+this._config.pageConfigureLinkText+"</a></li>";if(true===this._config.showLogoutLink){s+="<li";if(-1!=this._config.logoutUrl.indexOf(window.location.pathname)){s+=" class='active'";}
s+="><a href='"+this._config.logoutUrl+"'>"+this._config.logoutLinkText+"</a></li>";}
s+="</ul></div><!--/.nav-collapse --></div><!--/.container-fluid --></div>";document.getElementById(this.container).innerHTML=s;var self=this;document.getElementById(this.container+"-workplacenavbar-configurepage").onclick=function(evt){com.marklogic.widgets.workplaceadmin.renderFullscreen(self._workplaceContext);evt.stopPropagation();return false;};};com.marklogic.widgets.workplacenavbar.prototype.updateMyPages=function(pages){this._refresh();};com.marklogic.widgets.workplacepagelist=function(container){this.container=container;this._workplaceContext=null;this._pages=new Array();};com.marklogic.widgets.workplacepagelist.prototype.setWorkplaceContext=function(ctx){mljs.defaultconnection.logger.debug("workplacepagelist.setWorkplaceContext: called.");this._workplaceContext=ctx;};com.marklogic.widgets.workplacepagelist.prototype.getWorkplaceContext=function(){return this._workplaceContext;};com.marklogic.widgets.workplacepagelist.prototype.updateWorkplace=function(){this.updateMyPages();};com.marklogic.widgets.workplacepagelist.prototype.updateMyPages=function(pages){this._pages=pages||this._pages;var str="<div class='panel panel-info'>";str+="<div class='panel-heading'>Pages</div>";str+="<div class='panel-body'>";for(var p=0,maxp=this._pages.length,page;p<maxp;p++){page=this._pages[p];str+="<div class='btn-toolbar'>";str+="<div class='btn-group'>";str+=" <button id='"+this.container+"-"+p+"-del' class='btn btn-danger'><span class='glyphicon glyphicon-remove btn-fix'></span></button>";str+=" <button id='"+this.container+"-"+p+"-edit'  class='btn btn-default'><span class='glyphicon glyphicon-cog btn-fix'></span></button>";str+=" <button id='"+this.container+"-"+p+"-name'  class='btn btn-default'><span class='btn-fix'>"+page.page.title+" @ ";if(undefined!=page.page.urls){for(var u=0,maxu=page.page.urls.length,url;u<maxu;u++){url=page.page.urls[u];if(u>0){str+=", ";}
str+=url;}}
str+="</span></button>";str+="</div>";str+="</div>";}
if(0==this._pages.length){str+="<p><i>No pages to display</i></p>";}
str+="<div class='form-group'>";str+=" <label>New page name</label>";str+=" <div class='input-group'>";str+="  <input id='"+this.container+"-pagename' class='form-control' type='text' placeholder='Page name'/>";str+="  <div id='"+this.container+"-addpage' class='input-group-addon glyphicon glyphicon-plus'></div>";str+=" </div>";str+="</div>";str+="</div>";str+="</div>";document.getElementById(this.container).innerHTML=str;var self=this;var addDelHandler=function(elid,page){var el=document.getElementById(elid);el.onclick=function(evt){self._workplaceContext.deletePage(page.uri);evt.stopPropagation();return false;};};var addEditHandler=function(elid,page){var el=document.getElementById(elid);el.onclick=function(evt){com.marklogic.widgets.workplaceadmin.renderFullscreen(self._workplaceContext);self._workplaceContext.loadWorkplace(page.uri);evt.stopPropagation();return false;};};for(var p=0,maxp=this._pages.length,page;p<maxp;p++){page=this._pages[p];addDelHandler(this.container+"-"+p+"-del",page);addEditHandler(this.container+"-"+p+"-edit",page);addEditHandler(this.container+"-"+p+"-name",page);}
document.getElementById(this.container+"-addpage").onclick=function(evt){var json={title:document.getElementById(self.container+"-pagename").value,actions:{onload:[],onunload:[]},contexts:[{context:"searchcontext1",type:"SearchContext",config:{}},{context:"semanticcontext1",type:"SemanticContext",config:{}},{context:"geocontext1",type:"GeoContext",config:{}},{context:"doccontext1",type:"DocumentContext",config:{}},{context:"alertcontext1",type:"AlertContext",config:{}},{context:"datacontext1",type:"DataContext",config:{}}]};self._workplaceContext.createPage(json);evt.stopPropagation();return false;};};com.marklogic.widgets.pagecontext=function(){this._workplaceContext=null;this._workplaceWidget=null;this._params=null;this._defaultConfig={mappings:{},calls:[]};this._config=this._defaultConfig;com.marklogic.widgets.pagecontext.instance=this;};com.marklogic.widgets.pagecontext.prototype.setWorkplaceWidget=function(wgt){this._workplaceWidget=wgt;};com.marklogic.widgets.pagecontext.prototype.setWorkplaceContext=function(ctx){this._workplaceContext=ctx;};com.marklogic.widgets.pagecontext.prototype.setMappings=function(mappings){this._config.mappings=mappings;};com.marklogic.widgets.pagecontext.prototype.process=function(ctx){var params=this._parse();var objects={};for(var name in this._config.mappings){console.log("PC: found mapping name: "+name);var mapping=this._config.mappings[name];var value=params[mapping.querystring];console.log("PC: mapping has value: "+value);if(undefined!=value){for(var t=0,maxt=mapping.targets.length,target;t<maxt;t++){target=mapping.targets[t];var classInstances=objects[target.class];console.log("PC: checking for instances of target class: "+target.class);if(undefined==classInstances){classInstances={};objects[target.class]=classInstances;}
var instances=this._workplaceContext.getInstancesOf(target.class);for(var i=0,maxi=instances.length,ins;i<maxi;i++){ins=instances[i];var iname=ins;console.log("PC: Found instance: "+iname);var cinstance=classInstances[iname];if(undefined==cinstance){cinstance={};classInstances[iname]=cinstance;}
console.log("PC: Setting instance config value "+name+"="+value);cinstance[name]=value;}}}}
console.log("PC: processing configs...");for(var cname in objects){console.log("PC: Processing class: "+cname);var obj=objects[cname];for(var iname in obj){console.log("PC: Loading instance name: "+iname);var config=obj[iname];var wgt=this._workplaceWidget.getInstance(iname);console.log("PC: Got instance?: "+(undefined!=wgt));wgt.setConfiguration(config);}}
var json=ctx.getJson();if(undefined!=json){var pageMappings=json.pageMappings;if(undefined==pageMappings){pageMappings=this._config;}
var calls=pageMappings.calls;if(undefined!=calls){for(var c=0,maxc=calls.length,cal;c<maxc;c++){cal=calls[c];mljs.defaultconnection.logger.debug("pagecontext.process: processing call: "+cal.title);var instances=new Array();if(undefined!=cal.target.instance){instances.push(this._workplaceWidget.getInstance(cal.target.instance));}else{if(undefined!=cal.target.class){var instanceNames=ctx.getInstancesOf(cal.target.class);for(var ini=0,maxini=instanceNames.length,inn;ini<maxini;ini++){inn=instanceNames[ini];instances.push(this._workplaceWidget.getInstance(inn));}}}
for(var i=0,maxi=instances.length,ins;i<maxi;i++){ins=instances[i];if(undefined!=ins){var validCall=true;var paramValues=[];if(undefined!=cal.target.params){for(var p=0,maxp=cal.target.params.length,param;p<maxp;p++){param=cal.target.params[p];var paramValue=params[param.querystring];paramValues[p]=paramValue;mljs.defaultconnection.logger.debug("pagecontext.process: param value: "+paramValue);validCall=validCall&&(!param.required||undefined!=paramValue);}}
if(validCall){mljs.defaultconnection.logger.debug("pagecontext.process: call is valid, checking target method: "+cal.target.method+" on instance: "+ins);var func=ins[cal.target.method];if(undefined!=func){mljs.defaultconnection.logger.debug("pagecontext.process: Calling "+JSON.stringify(cal));func.apply(ins,paramValues);}}else{mljs.defaultconnection.logger.debug("pagecontext.process: Not a valid call for: "+cal.target.instance+"("+cal.target.class+")."+cal.target.method);}}}}}}};com.marklogic.widgets.pagecontext.prototype.getParameter=function(name){if(null==this._params){this._params=this._parse();}
return this._params[name];};com.marklogic.widgets.pagecontext.prototype._parse=function(){var result={};var str=window.location.search.substring(1);var pos=str.indexOf("&");var op=0;do{var np=pos;if(-1==pos){np=str.length;}else{pos=str.indexOf("&",np+1);}
var sub=str.substring(op,np);console.log("PC: Sub: "+sub);var qp=sub.indexOf("=");console.log("PC: qp: "+qp);var value=null;var name=null;if(-1!=qp){name=sub.substring(0,qp);value=decodeURI(sub.substring(qp+1));}else{name=sub;}
console.log("PC: name: "+name+" = "+value);result[name]=value;}while(-1!=pos);return result;};